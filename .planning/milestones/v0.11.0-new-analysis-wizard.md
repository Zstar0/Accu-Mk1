# Milestone v0.11.0: New Analysis Wizard

**Status:** ✅ SHIPPED 2026-02-20
**Phases:** 1–5
**Total Plans:** 9
**Duration:** 2026-02-19 → 2026-02-20
**Commits:** ~48 commits | 56 files changed | +11,672 / -279 lines

## Overview

Added a guided 5-step sample preparation wizard to the existing FastAPI + React lab app. The wizard captures weighing data from a Mettler Toledo XSR105DU balance over TCP, performs stock prep and dilution calculations using Decimal arithmetic, writes a complete audit-trail session record to SQLite, and optionally retrieves sample details from SENAITE LIMS. Build order — DB foundation first, scale bridge second, SSE integration third, UI fourth, SENAITE last — kept every phase independently testable and de-risked the two external dependencies (hardware, LIMS) until the wizard core was solid.

## Phases

### Phase 1: DB Models and Calculation Foundation

**Goal**: Tech can run a complete sample prep wizard session using manual weight entry, with all measurements and calculated values persisted to the database.
**Depends on**: Nothing (no hardware or external services required)
**Plans**: 2 plans

Plans:
- [x] 01-01-PLAN.md — DB models (WizardSession, WizardMeasurement), wizard_sessions/wizard_measurements tables, 6 REST endpoints for session lifecycle
- [x] 01-02-PLAN.md — Decimal calculation engine (calc_stock_prep, calc_required_volumes, calc_actual_dilution, calc_results) with TDD unit tests verified against lab Excel values

**Key files created:**
- `backend/calculations/hplc_processor.py` — calc_stock_prep, calc_required_volumes, calc_actual_dilution, calc_results (Decimal arithmetic)
- `backend/parsers/peakdata_csv_parser.py` — WizardSession, WizardMeasurement models + init_db table creation
- `backend/main.py` — 6 wizard session REST endpoints (start, get, update, measure, complete, list)

---

### Phase 2: Scale Bridge Service

**Goal**: Backend connects to the Mettler Toledo XSR105DU over TCP and correctly reads stable weights using MT-SICS protocol, with the scale status exposed via API.
**Depends on**: Phase 1
**Plans**: 1 plan

Plans:
- [x] 02-01-PLAN.md — ScaleBridge singleton, MT-SICS TCP client, FastAPI lifespan registration, status endpoint, settings, standalone test script

**Key files created:**
- `backend/scale_bridge.py` — ScaleBridge asyncio TCP client, SI command/response, asyncio.Lock concurrency guard
- `test_scale.py` — standalone hardware test script (runs without FastAPI)

---

### Phase 3: SSE Weight Streaming

**Goal**: Tech sees live weight readings stream into the wizard UI in real time, with a clear stable-weight indicator, and can fall back to manual entry when the scale is offline.
**Depends on**: Phase 2
**Plans**: 1 plan

Plans:
- [x] 03-01-PLAN.md — SSE weight stream endpoint, useScaleStream frontend hook with stability detection, WeightInput component with SSE/manual dual mode

**Key files created:**
- `src/lib/scale-stream.ts` — useScaleStream hook, 5-reading rolling window stability detection (max-min ≤ 0.5 mg)
- `src/components/hplc/WeightInput.tsx` — dual-mode weight input (SSE live display vs manual entry fallback)

---

### Phase 4: Wizard UI

**Goal**: Tech can navigate through the complete 5-step sample prep wizard with animated step transitions, sequential locking, and completed steps reviewable.
**Depends on**: Phase 3
**Plans**: 3 plans

Plans:
- [x] 04-01-PLAN.md — PrepWizardStore (Zustand), wizard API functions, WizardPage layout with step sidebar, animated transitions
- [x] 04-02-PLAN.md — Step 1 (Sample Info form), Step 2 (Stock Prep weighing), Step 3 (Dilution weighing) wired to API and WeightInput
- [x] 04-03-PLAN.md — Step 4 (Results entry), Step 5 (Summary), WizardSessionHistory, AnalysisHistory tabs

**Key files created:**
- `src/store/wizard-store.ts` — PrepWizardStore with stepStates field, deriveStepStates pure function, WIZARD_STEPS constant
- `src/components/hplc/CreateAnalysis.tsx` — WizardPage split-panel layout (all 5 steps wired)
- `src/components/hplc/wizard/steps/Step1SampleInfo.tsx` (v1) — sample info form
- `src/components/hplc/wizard/steps/Step2StockPrep.tsx` — 4 weighing sub-steps with calculated outputs
- `src/components/hplc/wizard/steps/Step3Dilution.tsx` — 3 weighing sub-steps
- `src/components/hplc/wizard/steps/Step4Results.tsx` — peak area entry + calculated results card
- `src/components/hplc/wizard/steps/Step5Summary.tsx` — full read-only session summary + Complete button
- `src/components/hplc/wizard/WizardSessionHistory.tsx` — completed sessions table
- `src/components/hplc/AnalysisHistory.tsx` — refactored with HPLC Import + Sample Prep Wizard tabs

---

### Phase 5: SENAITE Sample Lookup

**Goal**: Tech can search for a SENAITE sample by ID in step 1 of the wizard and have sample details auto-populated, with a manual entry fallback when SENAITE is unavailable.
**Depends on**: Phase 4
**Plans**: 2 plans

Plans:
- [x] 05-01-PLAN.md — SENAITE backend endpoints (status + lookup), httpx client with Basic auth, analyte name stripping, fuzzy peptide matching, frontend API types and functions
- [x] 05-02-PLAN.md — Step1SampleInfo two-tab UI rewrite (SENAITE Lookup + Manual Entry), lookup summary card, blend analyte display, error states

**Key files modified:**
- `backend/main.py` — GET /wizard/senaite/status, GET /wizard/senaite/lookup, httpx BasicAuth client, _strip_method_suffix(), _fuzzy_match_peptide()
- `src/lib/api.ts` — SenaiteAnalyte, SenaiteLookupResult, SenaiteStatusResponse types; getSenaiteStatus, lookupSenaiteSample functions
- `src/components/hplc/wizard/steps/Step1SampleInfo.tsx` (v2) — two-tab SENAITE Lookup / Manual Entry with blue result card, analyte match indicators, graceful degradation

---

## Milestone Summary

**Key Decisions:**
- Use `Decimal` arithmetic from first formula — no retrofitting allowed
- Store only raw weights in DB; recalculate all derived values on demand
- ScaleBridge as singleton on `app.state` (not per-request connection)
- SSE via `StreamingResponse` (existing codebase pattern — 4 endpoints already using it)
- SCALE_HOST env var controls scale mode; absent = manual-entry mode (no crash)
- Stability detection is pure frontend rolling window — server stays stateless
- WeightInput uses local state only (not Zustand) — transient UI, not shared, not persisted
- `stepStates` stored as Zustand field (not computed selector) — stable reference
- `deriveStepStates` exported as pure function callable outside the store
- SENAITE_URL absent = lookup tab hidden; same optional pattern as SCALE_HOST
- Error differentiation: 404 for sample not found, 503 for SENAITE unavailable
- Fuzzy peptide match uses simple contains — not Levenshtein
- Tab switch clears all fields (peptideId, sampleIdLabel, declaredWeightMg) on change

**Issues Resolved During Milestone:**
- `_build_session_response` in `main.py` had wrong `calc_results` arg order — caught and fixed during 01-01 execution (b1d441c)
- `asyncio.Lock` added per-bridge to guard concurrent SI command/response cycles on shared TCP stream
- `AnalysisHistory` early-return converted to conditional render inside TabsContent — tabs now persist in detail view
- SENAITE httpx.Timeout constructor call corrected (fix 05)
- SENAITE auth failure vs sample-not-found error differentiated (fix 05)
- Next Step always disabled bug + stock prep locking bug fixed post-Phase 4

**Issues Deferred:**
- Scale hardware testing: scale at 192.168.3.113 on remote network; `test_scale.py` ready when accessible
- WeightInput stability detection not exercised with real scale data — relies on manual-entry fallback in testing
- No end-to-end SENAITE integration test (requires live SENAITE instance)

**Technical Debt Incurred:**
- Scale hardware path untested in production — deferred to when hardware is accessible on network
- SENAITE env vars documented but not validated in CI
- Wizard state not fully covered by automated tests (integration tests would require test DB fixtures)

---

*Requirements archived: .planning/milestones/v0.11.0-REQUIREMENTS.md*
*Roadmap archived from: .planning/ROADMAP.md*
*Archived: 2026-02-20*
