---
phase: 02-data-pipeline
plan: 02-01
title: Settings Backend and UI
wave: 1
status: pending
requirements: [SETTINGS-01, SETTINGS-02]
depends_on: []
created: 2026-01-16
---

## Goal

Build settings infrastructure for configuring column mappings, report directory, and other calculation parameters that will be used by the import and calculation pipelines.

## Context

Phase 1 established the FastAPI backend with SQLite database. This plan adds a Settings table and API endpoints, plus a React settings panel. Settings are foundational - the import and calculation plans depend on knowing column names and file paths.

## Tasks

### Task 1: Settings Database Model and API

**Files to create/modify:**
- `backend/models.py` - Add Settings model
- `backend/main.py` - Add settings CRUD endpoints

**Implementation:**

1. Add Settings model to models.py:
```python
class Settings(Base):
    __tablename__ = "settings"

    id: Mapped[int] = mapped_column(primary_key=True, autoincrement=True)
    key: Mapped[str] = mapped_column(String(100), unique=True, nullable=False)
    value: Mapped[str] = mapped_column(Text, nullable=False)
    updated_at: Mapped[datetime] = mapped_column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
```

2. Add endpoints to main.py:
   - `GET /settings` - List all settings
   - `GET /settings/{key}` - Get single setting
   - `PUT /settings/{key}` - Create/update setting
   - `DELETE /settings/{key}` - Delete setting

3. Seed default settings on startup:
   - `report_directory` - Default empty string
   - `column_mappings` - JSON with default column names

### Task 2: Settings TypeScript Client

**Files to create/modify:**
- `src/lib/api.ts` - Add settings API functions

**Implementation:**

1. Add typed interfaces:
```typescript
interface Setting {
  id: number
  key: string
  value: string
  updated_at: string
}
```

2. Add API functions:
   - `getSettings(): Promise<Setting[]>`
   - `getSetting(key: string): Promise<Setting>`
   - `updateSetting(key: string, value: string): Promise<Setting>`

### Task 3: Settings UI Panel

**Files to create/modify:**
- `src/components/SettingsPanel.tsx` - New settings component
- `src/components/MainWindow.tsx` - Add settings tab/section

**Implementation:**

1. Create SettingsPanel component with:
   - Report directory input with folder picker (text input for now, Tauri dialog later)
   - Column mapping editor (key-value pairs)
   - Save button that calls updateSetting for each changed value

2. Add to MainWindow:
   - Settings icon/button in header or sidebar
   - Conditional render of SettingsPanel

3. Use shadcn/ui components: Input, Button, Card, Label

## Verification

```bash
# Backend settings API works
curl http://127.0.0.1:8009/settings
curl -X PUT http://127.0.0.1:8009/settings/report_directory -H "Content-Type: application/json" -d '{"value": "/path/to/reports"}'
curl http://127.0.0.1:8009/settings/report_directory

# Frontend shows settings panel
npm run dev
# Navigate to settings, change a value, verify it persists after refresh
```

## Must-Haves

- [ ] Settings table exists in SQLite with key-value structure
- [ ] GET/PUT endpoints work for settings CRUD
- [ ] Frontend can display and edit settings
- [ ] Settings persist across app restarts
- [ ] Column mappings stored as JSON setting

## Notes

- Keep settings simple key-value for flexibility
- Column mappings JSON structure: `{"peak_area": "Area", "retention_time": "RT", ...}`
- Tauri folder dialog integration deferred to later - use text input for now
