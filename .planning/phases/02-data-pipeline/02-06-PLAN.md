---
phase: 02-data-pipeline
plan: 06
type: execute
wave: 1
depends_on: []
files_modified: [backend/calculations/formulas.py, backend/calculations/engine.py, backend/main.py]
autonomous: true
gap_closure: true
must_haves:
  truths:
    - "Compounds identified by retention time ranges"
  artifacts:
    - path: "backend/calculations/formulas.py"
      provides: "CompoundIdentificationFormula class"
      contains: "class CompoundIdentificationFormula"
  key_links:
    - from: "CompoundIdentificationFormula"
      to: "CalculationEngine"
      via: "formula_registry"
---

<objective>
Implement compound identification by matching retention times to configured ranges.

Purpose: Close gap from verification - no compound identification exists.
Output: CompoundIdentificationFormula that identifies compounds based on RT ranges.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-data-pipeline/02-04-SUMMARY.md

@backend/calculations/formulas.py
@backend/calculations/engine.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add CompoundIdentificationFormula class</name>
  <files>backend/calculations/formulas.py</files>
  <action>
    Add CompoundIdentificationFormula class:

    Settings required:
    - compound_ranges: JSON string with format:
      {"CompoundA": {"rt_min": 1.0, "rt_max": 2.0}, "CompoundB": {"rt_min": 3.5, "rt_max": 4.5}}

    Inputs:
    - rows with retention_time values

    Algorithm:
    - For each row with retention_time, check which compound range it falls into
    - A row matches if rt_min <= retention_time <= rt_max

    Outputs:
    - identified_compounds: List of {compound_name, retention_time, peak_area}
    - unidentified_peaks: List of {retention_time, peak_area} that didn't match any range
    - compound_summary: Dict of compound -> count of peaks

    Validation:
    - compound_ranges setting must exist and be valid JSON
    - must have at least one row with retention_time
  </action>
  <verify>python -c "from formulas import CompoundIdentificationFormula; print(CompoundIdentificationFormula)"</verify>
  <done>CompoundIdentificationFormula class exists with validate() and execute()</done>
</task>

<task type="auto">
  <name>Task 2: Register CompoundIdentificationFormula in engine</name>
  <files>backend/calculations/engine.py</files>
  <action>
    1. Import CompoundIdentificationFormula from formulas
    2. Add to FORMULA_REGISTRY: "compound_id": CompoundIdentificationFormula
    3. Include in calculate_all default formulas if compound_ranges setting exists
  </action>
  <verify>python -c "from engine import FORMULA_REGISTRY; print('compound_id' in FORMULA_REGISTRY)"</verify>
  <done>compound_id formula registered and callable</done>
</task>

<task type="auto">
  <name>Task 3: Add compound_ranges default setting</name>
  <files>backend/main.py</files>
  <action>
    In seed_default_settings(), add:
    - compound_ranges: '{}' (empty JSON object as placeholder)

    User will configure actual compound ranges in settings UI.
  </action>
  <verify>curl http://127.0.0.1:8009/settings | grep compound_ranges</verify>
  <done>compound_ranges setting exists in database</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] CompoundIdentificationFormula class exists
- [ ] Formula registered in FORMULA_REGISTRY as "compound_id"
- [ ] compound_ranges setting seeded
- [ ] Manual test: configure compound_ranges, run calculation, see identified compounds
</verification>

<success_criteria>
- CompoundIdentificationFormula matches RT to configured ranges
- Returns identified compounds with names and unidentified peaks
- Registered in engine
- Default setting seeded
</success_criteria>

<output>
After completion, create `.planning/phases/02-data-pipeline/02-06-SUMMARY.md`
</output>
