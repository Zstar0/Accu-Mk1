---
phase: 06-data-foundation-inline-editing
plan: 03
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/components/senaite/AnalysisTable.tsx
  - src/components/senaite/SampleDetails.tsx
autonomous: true

must_haves:
  truths:
    - "The analyses table renders from a standalone AnalysisTable component in its own file"
    - "SampleDetails.tsx no longer contains analysis table rendering logic inline"
    - "AnalysisTable receives analyses data, filter state, and analyteNameMap as props"
  artifacts:
    - path: "src/components/senaite/AnalysisTable.tsx"
      provides: "Standalone analysis table component with filter tabs and progress bar"
      min_lines: 120
    - path: "src/components/senaite/SampleDetails.tsx"
      provides: "Sample details page importing AnalysisTable"
      contains: "AnalysisTable"
  key_links:
    - from: "src/components/senaite/SampleDetails.tsx"
      to: "src/components/senaite/AnalysisTable.tsx"
      via: "import and props"
      pattern: "import.*AnalysisTable.*from"
    - from: "AnalysisTable.tsx"
      to: "SenaiteAnalysis type"
      via: "typed props"
      pattern: "SenaiteAnalysis"
---

<objective>
Extract the analyses table section from SampleDetails.tsx into a standalone AnalysisTable component with its own file. Move all analysis-related rendering (filter tabs, progress bar, table, AnalysisRow) out of the 1349-line file.

Purpose: SampleDetails.tsx is 1349 lines. Adding inline editing state directly would push it well past maintainability limits. The component extraction is mandatory (per locked decision) before adding any new state management in Plan 04.
Output: AnalysisTable.tsx as a self-contained component; SampleDetails.tsx reduced by ~200 lines.
</objective>

<execution_context>
@C:\Users\forre\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\forre\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-data-foundation-inline-editing/06-01-SUMMARY.md

Key source:
- src/components/senaite/SampleDetails.tsx — lines 1173-1349 contain the analyses table section + AnalysisRow + formatAnalysisTitle
- src/components/senaite/SampleDetails.tsx — lines 139-158 contain ROW_STATUS_STYLE (used by AnalysisRow)
- src/components/senaite/SampleDetails.tsx — lines 242-254 contain StatusBadge (used by AnalysisRow)
- src/components/senaite/SampleDetails.tsx — lines 256-286 contain TabButton (used by filter tabs)
- src/components/senaite/SampleDetails.tsx — lines 636-650 contain analysis filtering/progress logic
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AnalysisTable.tsx with extracted analysis rendering</name>
  <files>src/components/senaite/AnalysisTable.tsx, src/components/senaite/SampleDetails.tsx</files>
  <action>
  Create `src/components/senaite/AnalysisTable.tsx` containing all analysis table rendering extracted from SampleDetails.tsx.

  **What to move to AnalysisTable.tsx:**

  1. The `AnalysisRow` component (lines 1305-1349) and `formatAnalysisTitle` helper (lines 1292-1303)
  2. The `ROW_STATUS_STYLE` constant (lines 139-158) — needed by AnalysisRow
  3. The `StatusBadge` component (lines 242-254) and `STATUS_COLORS`/`STATUS_LABELS` constants — needed by AnalysisRow. NOTE: StatusBadge is also used in SampleDetails at line 716 for the sample-level badge. Keep StatusBadge exported so SampleDetails can import it back. OR: move StatusBadge to a shared location. Best approach: export StatusBadge and STATUS_LABELS from AnalysisTable.tsx and import in SampleDetails.tsx.
  4. The `TabButton` component (lines 256-286) — used only by the analysis filter tabs
  5. The entire analyses Card JSX block (lines 1173-1283) — the filter tabs, progress bar, and table

  **AnalysisTable props interface:**

  ```typescript
  interface AnalysisTableProps {
    analyses: SenaiteAnalysis[]
    analyteNameMap: Map<number, string>
  }
  ```

  The component manages its own filter state (`analysisFilter`) internally since it's UI-only state. It also computes `verifiedCount`, `pendingCount`, `progressPct`, and `filteredAnalyses` internally from the `analyses` prop.

  **AnalysisTable structure:**
  ```typescript
  export function AnalysisTable({ analyses, analyteNameMap }: AnalysisTableProps) {
    const [analysisFilter, setAnalysisFilter] = useState<'all' | 'verified' | 'pending'>('all')

    const verifiedCount = analyses.filter(
      a => a.review_state === 'verified' || a.review_state === 'published'
    ).length
    const pendingCount = analyses.length - verifiedCount
    const progressPct = analyses.length > 0 ? Math.round((verifiedCount / analyses.length) * 100) : 0
    const filteredAnalyses = analyses.filter(a => { ... })

    if (analyses.length === 0) return null

    return (
      <Card className="p-4 mb-6">
        {/* Filter tabs, progress bar, table — same JSX as current */}
      </Card>
    )
  }
  ```

  **Imports needed in AnalysisTable.tsx:**
  - `useState` from 'react'
  - `Activity` from 'lucide-react' (section icon)
  - `Card` from '@/components/ui/card'
  - `Badge` from '@/components/ui/badge' (if needed — check StatusBadge)
  - `type SenaiteAnalysis` from '@/lib/api'

  **What to keep in SampleDetails.tsx:**
  - Remove: `analysisFilter` state, `filteredAnalyses` computation, `verifiedCount`/`pendingCount`/`progressPct` computations, the analyses Card JSX block, AnalysisRow, formatAnalysisTitle, TabButton
  - Keep: `ROW_STATUS_STYLE` can move out. `StatusBadge` must remain accessible to SampleDetails (export from AnalysisTable and re-import).
  - Replace the analyses section (lines 1173-1283) with: `<AnalysisTable analyses={analyses} analyteNameMap={analyteNameMap} />`
  - The `analyses` const at line 636 and `analyteNameMap` at line 656 stay in SampleDetails — they are passed as props.

  **Important:** Do NOT use the `data-table.tsx` TanStack Table component for this. Keep the hand-built HTML table. TanStack Table will be considered in Phase 08 for checkbox selection. The current plain table is simpler and works well.

  **Style:** Follow project conventions — no semicolons, single quotes, 2-space indent, named exports, `@/` imports. Use `import type` for type-only imports.
  </action>
  <verify>
  1. `npm run typecheck` passes
  2. `npm run lint` passes (or only has pre-existing warnings)
  3. File exists: `ls src/components/senaite/AnalysisTable.tsx`
  4. SampleDetails.tsx is shorter: `wc -l src/components/senaite/SampleDetails.tsx` should be ~1100-1150 lines (down from 1349)
  5. SampleDetails imports AnalysisTable: grep for "import.*AnalysisTable" in SampleDetails.tsx
  6. AnalysisTable.tsx contains AnalysisRow: grep for "function AnalysisRow" in AnalysisTable.tsx
  </verify>
  <done>AnalysisTable is a standalone component in its own file. SampleDetails.tsx imports and renders it with analyses + analyteNameMap props. No visual change to the user — pure refactor.</done>
</task>

</tasks>

<verification>
1. `npm run typecheck` passes with zero errors
2. `npm run lint` passes
3. AnalysisTable.tsx exists with AnalysisRow, TabButton, StatusBadge, filter logic
4. SampleDetails.tsx imports AnalysisTable and passes analyses + analyteNameMap as props
5. SampleDetails.tsx no longer contains AnalysisRow, TabButton, formatAnalysisTitle, or the analyses Card JSX block
6. StatusBadge is still usable by SampleDetails (via import from AnalysisTable)
</verification>

<success_criteria>
- src/components/senaite/AnalysisTable.tsx exists as a standalone component (COMP-01)
- AnalysisTable receives analyses and analyteNameMap as props (COMP-02)
- SampleDetails.tsx no longer contains inline analysis rendering logic
- SampleDetails.tsx line count reduced by ~150-200 lines
- TypeScript compiles cleanly, lint passes
- No visual changes — same UI behavior
</success_criteria>

<output>
After completion, create `.planning/phases/06-data-foundation-inline-editing/06-03-SUMMARY.md`
</output>
