---
phase: 05-senaite-sample-lookup
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/components/hplc/wizard/steps/Step1SampleInfo.tsx
autonomous: true

must_haves:
  truths:
    - "Tech can type a SENAITE sample ID and click Look Up to auto-populate sample details"
    - "On successful lookup, a read-only summary card displays sample ID, declared weight, and all analyte names"
    - "First matched analyte auto-selects the peptide dropdown; tech can override the selection"
    - "Tech can toggle between SENAITE Lookup and Manual Entry tabs at any time"
    - "Switching to Manual Entry after a lookup clears all pre-filled state"
    - "When SENAITE_URL is not configured, only Manual Entry tab is shown"
    - "Sample not found shows 'Sample [ID] not found in SENAITE' error"
    - "SENAITE unreachable shows 'SENAITE is currently unavailable' error"
    - "Target conc/vol fields appear below the lookup summary card, tech fills them manually"
    - "Session creation uses the same createWizardSession call regardless of lookup or manual entry"
  artifacts:
    - path: "src/components/hplc/wizard/steps/Step1SampleInfo.tsx"
      provides: "Two-tab Step 1 with SENAITE lookup and manual entry"
      min_lines: 250
  key_links:
    - from: "src/components/hplc/wizard/steps/Step1SampleInfo.tsx"
      to: "/wizard/senaite/status"
      via: "getSenaiteStatus() call in useEffect on mount"
      pattern: "getSenaiteStatus"
    - from: "src/components/hplc/wizard/steps/Step1SampleInfo.tsx"
      to: "/wizard/senaite/lookup"
      via: "lookupSenaiteSample() call on button click"
      pattern: "lookupSenaiteSample"
    - from: "src/components/hplc/wizard/steps/Step1SampleInfo.tsx"
      to: "createWizardSession"
      via: "handleSubmit form submission"
      pattern: "createWizardSession"
---

<objective>
Rewrite Step1SampleInfo with a two-tab UI: SENAITE Lookup and Manual Entry.

Purpose: Tech can search for a SENAITE sample by ID to auto-populate peptide, sample ID, and declared weight fields -- or use manual entry as before. This is the primary user-facing feature of Phase 5.

Output: Fully rewritten `Step1SampleInfo.tsx` with controlled tabs, lookup flow, read-only summary card for SENAITE results, blend analyte display, and unchanged session creation path.
</objective>

<execution_context>
@C:\Users\forre\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\forre\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-senaite-sample-lookup/05-CONTEXT.md
@.planning/phases/05-senaite-sample-lookup/05-RESEARCH.md
@.planning/phases/05-senaite-sample-lookup/05-01-SUMMARY.md
@src/components/hplc/wizard/steps/Step1SampleInfo.tsx
@src/lib/api.ts
@src/components/hplc/AnalysisHistory.tsx
@src/store/wizard-store.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite Step1SampleInfo with SENAITE lookup tabs</name>
  <files>src/components/hplc/wizard/steps/Step1SampleInfo.tsx</files>
  <action>
Rewrite `Step1SampleInfo.tsx` to add a two-tab UI. The existing read-only session summary (lines 74-140) is UNCHANGED. The form section below it gets replaced with a tabbed layout.

**New imports to add:**
```typescript
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs'
import {
  getSenaiteStatus,
  lookupSenaiteSample,
  type SenaiteLookupResult,
} from '@/lib/api'
```

**New state variables (in addition to existing ones):**
```typescript
// SENAITE state
const [senaiteEnabled, setSenaiteEnabled] = useState(false)
const [checkingStatus, setCheckingStatus] = useState(true)
const [activeTab, setActiveTab] = useState<'lookup' | 'manual'>('manual')

// Lookup state
const [lookupId, setLookupId] = useState('')
const [lookupLoading, setLookupLoading] = useState(false)
const [lookupError, setLookupError] = useState<string | null>(null)
const [lookupResult, setLookupResult] = useState<SenaiteLookupResult | null>(null)
```

**SENAITE status check on mount (add to existing useEffect area):**
- Call `getSenaiteStatus()` on mount (same pattern as existing loadPeptides).
- If enabled: `setSenaiteEnabled(true)`, `setActiveTab('lookup')`.
- If error or disabled: `setSenaiteEnabled(false)`, `setActiveTab('manual')`.
- Set `setCheckingStatus(false)` in finally block.
- Use cancellation flag pattern (same as existing peptides loader).

**Tab change handler:**
```typescript
function handleTabChange(tab: string) {
  if (tab === 'manual') {
    // Per user decision: clear everything when switching to manual
    setPeptideId(null)
    setSampleIdLabel('')
    setDeclaredWeightMg('')
    setLookupResult(null)
    setLookupError(null)
  }
  if (tab === 'lookup') {
    // Clear manual-entered values when switching back to lookup
    setPeptideId(null)
    setSampleIdLabel('')
    setDeclaredWeightMg('')
  }
  setActiveTab(tab as 'lookup' | 'manual')
}
```

**Lookup handler (on "Look Up" button click):**
```typescript
async function handleLookup() {
  if (!lookupId.trim()) return
  setLookupLoading(true)
  setLookupError(null)
  setLookupResult(null)
  try {
    const result = await lookupSenaiteSample(lookupId.trim())
    setLookupResult(result)
    // Auto-populate fields from SENAITE data
    setSampleIdLabel(result.sample_id)
    if (result.declared_weight_mg != null) {
      setDeclaredWeightMg(String(result.declared_weight_mg))
    }
    // Auto-select first matched peptide (per decision: first match wins for peptide_id)
    const firstMatch = result.analytes.find(a => a.matched_peptide_id !== null)
    if (firstMatch?.matched_peptide_id != null) {
      setPeptideId(firstMatch.matched_peptide_id)
    }
  } catch (err) {
    setLookupError(err instanceof Error ? err.message : 'Lookup failed')
  } finally {
    setLookupLoading(false)
  }
}
```

**Component structure (form section, when session === null):**

```
<Card>
  <CardHeader><CardTitle>Sample Information</CardTitle></CardHeader>
  <CardContent>
    {/* Error alerts (submitError, peptideError) — same as before */}

    {checkingStatus ? (
      /* Small loading indicator while checking SENAITE status */
      <div className="flex items-center gap-2 text-sm text-muted-foreground mb-4">
        <Loader2 className="h-4 w-4 animate-spin" /> Checking SENAITE...
      </div>
    ) : null}

    <Tabs value={activeTab} onValueChange={handleTabChange}>
      <TabsList className="mb-4">
        {senaiteEnabled && (
          <TabsTrigger value="lookup">SENAITE Lookup</TabsTrigger>
        )}
        <TabsTrigger value="manual">Manual Entry</TabsTrigger>
      </TabsList>

      {/* ---- SENAITE LOOKUP TAB ---- */}
      {senaiteEnabled && (
        <TabsContent value="lookup" className="space-y-4">
          {/* Search row: Input + Look Up button */}
          <div className="flex gap-2">
            <div className="flex-1">
              <Label htmlFor="senaite-search">Sample ID</Label>
              <Input
                id="senaite-search"
                placeholder="e.g. P-0112"
                value={lookupId}
                onChange={e => setLookupId(e.target.value)}
                onKeyDown={e => e.key === 'Enter' && (e.preventDefault(), handleLookup())}
              />
            </div>
            <Button
              type="button"
              variant="secondary"
              onClick={handleLookup}
              disabled={!lookupId.trim() || lookupLoading}
              className="self-end"
            >
              {lookupLoading ? <Loader2 className="h-4 w-4 animate-spin" /> : 'Look Up'}
            </Button>
          </div>

          {/* Lookup error */}
          {lookupError && (
            <Alert variant="destructive">
              <AlertDescription>{lookupError}</AlertDescription>
            </Alert>
          )}

          {/* Lookup result: read-only summary card */}
          {lookupResult && (
            <div className="rounded-md border border-blue-500/30 bg-blue-50/50 dark:bg-blue-950/20 p-4 space-y-3">
              <div className="grid grid-cols-2 gap-3 text-sm">
                <div>
                  <span className="text-muted-foreground">Sample ID</span>
                  <p className="font-medium">{lookupResult.sample_id}</p>
                </div>
                <div>
                  <span className="text-muted-foreground">Declared Weight</span>
                  <p className="font-medium">
                    {lookupResult.declared_weight_mg != null
                      ? `${lookupResult.declared_weight_mg} mg`
                      : '(not provided)'}
                  </p>
                </div>
              </div>
              {/* Analytes list */}
              <div>
                <span className="text-muted-foreground text-sm">
                  {lookupResult.analytes.length === 1 ? 'Analyte' : 'Analytes'}
                </span>
                <ul className="mt-1 space-y-1">
                  {lookupResult.analytes.map((a, i) => (
                    <li key={i} className="text-sm">
                      <span className="font-medium">{a.raw_name}</span>
                      {a.matched_peptide_name ? (
                        <span className="text-green-600 dark:text-green-400 ml-2">
                          (matched: {a.matched_peptide_name})
                        </span>
                      ) : (
                        <span className="text-amber-600 dark:text-amber-400 ml-2">
                          (no local match)
                        </span>
                      )}
                    </li>
                  ))}
                </ul>
              </div>
            </div>
          )}

          {/* After lookup result: peptide dropdown + target fields + Create Session */}
          {/* Show the form fields once a lookup result is available OR always (so tech can fill targets) */}
          {lookupResult && (
            <form onSubmit={handleSubmit} className="space-y-4">
              {/* Peptide dropdown — editable so tech can override auto-selected match */}
              {/* SAME peptide dropdown as manual tab but pre-selected from lookup */}
              {renderPeptideSelect()}

              {/* Sample ID Label — read-only when populated from lookup */}
              <div className="space-y-1.5">
                <Label htmlFor="sample-id-label">Sample ID Label</Label>
                <Input
                  id="sample-id-label"
                  type="text"
                  value={sampleIdLabel}
                  readOnly
                  className="bg-muted"
                />
              </div>

              {/* Declared Weight — editable (may be null from SENAITE) */}
              <div className="space-y-1.5">
                <Label htmlFor="declared-weight">Declared Weight (mg)</Label>
                <Input
                  id="declared-weight"
                  type="number"
                  step="0.01"
                  placeholder="e.g. 10.00"
                  value={declaredWeightMg}
                  onChange={e => setDeclaredWeightMg(e.target.value)}
                />
              </div>

              {/* Target conc and vol — always manual per user decision */}
              {renderTargetFields()}
              {renderSubmitButton()}
            </form>
          )}
        </TabsContent>
      )}

      {/* ---- MANUAL ENTRY TAB ---- */}
      <TabsContent value="manual">
        {/* Existing form content — same as current Step1SampleInfo form */}
        <form onSubmit={handleSubmit} className="space-y-4">
          {renderPeptideSelect()}

          <div className="space-y-1.5">
            <Label htmlFor="sample-id-label">Sample ID Label</Label>
            <Input
              id="sample-id-label"
              type="text"
              placeholder="e.g. LOT-2024-001"
              value={sampleIdLabel}
              onChange={e => setSampleIdLabel(e.target.value)}
            />
          </div>

          <div className="space-y-1.5">
            <Label htmlFor="declared-weight">Declared Weight (mg)</Label>
            <Input
              id="declared-weight"
              type="number"
              step="0.01"
              placeholder="e.g. 10.00"
              value={declaredWeightMg}
              onChange={e => setDeclaredWeightMg(e.target.value)}
            />
          </div>

          {renderTargetFields()}
          {renderSubmitButton()}
        </form>
      </TabsContent>
    </Tabs>
  </CardContent>
</Card>
```

**Extract shared render helpers** to avoid duplication between tabs:
- `renderPeptideSelect()` — the peptide dropdown (loading state, Select component). Same code as current lines 200-226.
- `renderTargetFields()` — target conc + target vol inputs. Same code as current lines 253-283.
- `renderSubmitButton()` — Create Session button. Same code as current lines 285-294.

**CRITICAL implementation details:**
- Use Zustand selector syntax: `const session = useWizardStore(state => state.session)` (NOT destructuring)
- Capture `session.id` before any async closures (TypeScript narrowing pitfall)
- `handleSubmit` is shared between both tabs — it reads from the same local state variables regardless of which tab populated them
- `canSubmit` logic is unchanged: requires `peptideId !== null && targetConcUgMl.trim() !== '' && targetTotalVolUl.trim() !== ''`
- The read-only session summary at the top (shown when `session !== null`) is UNCHANGED from current implementation
- The SENAITE lookup summary card uses BLUE border/bg (to visually distinguish from the GREEN session-created summary)
- `onKeyDown` on the search input calls `handleLookup()` on Enter key (convenience)
- Wrap the entire form section in a `checkingStatus` guard so tabs don't flash before status is known

**Per user decisions (LOCKED):**
- Search field + "Look up" button (NOT as-you-type)
- Tabs toggle between "SENAITE Lookup" and "Manual Entry"
- Switching to manual clears everything (no pre-fill from lookup data)
- Target conc/vol fields appear below the summary card (tech fills manually)
- If SENAITE_URL not set: Lookup tab hidden, manual form shown directly
- Blend analytes: display all names in summary card, first match auto-selects peptide

**Per user decisions (DEFERRED — do NOT implement):**
- Multi-peak results handling for blend samples
- Real-time SENAITE status indicator on wizard load
  </action>
  <verify>
    - `npx tsc --noEmit` passes (no TypeScript errors)
    - `npm run check:all` passes (includes ast-grep Zustand check)
    - Grep Step1SampleInfo.tsx for: `Tabs`, `getSenaiteStatus`, `lookupSenaiteSample`, `handleTabChange`, `handleLookup` — all present
    - Grep Step1SampleInfo.tsx for: Zustand destructuring `useWizardStore()` — NOT present (only selector syntax)
  </verify>
  <done>
    - Step1SampleInfo shows two tabs (SENAITE Lookup + Manual Entry) when SENAITE is enabled
    - Step1SampleInfo shows only Manual Entry when SENAITE is disabled
    - Look Up button triggers SENAITE search; success shows read-only summary card with sample ID, weight, analyte names
    - First matched analyte auto-selects peptide dropdown; dropdown remains editable for override
    - Switching to Manual tab clears all lookup state
    - Error messages differentiate not-found vs. unavailable
    - Session creation uses same createWizardSession call regardless of source
    - Existing session read-only summary unchanged
  </done>
</task>

</tasks>

<verification>
- TypeScript compiles without errors
- ast-grep Zustand destructuring check passes
- Step1SampleInfo renders without errors (manual tab as default when SENAITE disabled)
- Both tabs functional: lookup tab has search + summary card, manual tab has full form
- Session creation path unchanged between tabs
</verification>

<success_criteria>
- Tech can search for SENAITE samples by ID and see results auto-populate
- Blend samples show all analyte names with match/no-match indicators
- Manual entry works identically to before (regression-free)
- Error states display correct differentiated messages
- Tab switching properly clears state per user decision
- SENAITE disabled state gracefully hides lookup tab
</success_criteria>

<output>
After completion, create `.planning/phases/05-senaite-sample-lookup/05-02-SUMMARY.md`
</output>
