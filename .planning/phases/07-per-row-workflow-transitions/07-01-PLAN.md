---
phase: 07-per-row-workflow-transitions
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/api.ts
  - src/hooks/use-analysis-transition.ts
  - src/components/senaite/AnalysisTable.tsx
autonomous: true

must_haves:
  truths:
    - "Each analysis row shows an action menu with only valid transitions for its current review_state"
    - "Unassigned rows show Submit; to_be_verified rows show Verify, Retract, Reject; verified rows show Retract"
    - "Clicking a non-destructive transition (Submit, Verify) executes immediately with a loading spinner on that row"
    - "Clicking a destructive transition (Retract, Reject) opens a confirmation dialog before executing"
    - "While a transition is in-flight, the row's action trigger shows a spinner and is disabled"
    - "Successful transitions show a success toast; failed transitions show an error toast with the backend message"
  artifacts:
    - path: "src/lib/api.ts"
      provides: "transitionAnalysis function"
      contains: "transitionAnalysis"
    - path: "src/hooks/use-analysis-transition.ts"
      provides: "useAnalysisTransition hook with pendingUids Set and pendingConfirm state"
      exports: ["useAnalysisTransition"]
    - path: "src/components/senaite/AnalysisTable.tsx"
      provides: "Actions column with DropdownMenu and AlertDialog"
      contains: "ALLOWED_TRANSITIONS"
  key_links:
    - from: "src/hooks/use-analysis-transition.ts"
      to: "src/lib/api.ts"
      via: "transitionAnalysis import"
      pattern: "import.*transitionAnalysis.*from.*api"
    - from: "src/components/senaite/AnalysisTable.tsx"
      to: "src/hooks/use-analysis-transition.ts"
      via: "useAnalysisTransition hook call"
      pattern: "useAnalysisTransition"
    - from: "DropdownMenuItem onClick"
      to: "executeTransition or requestConfirm"
      via: "DESTRUCTIVE_TRANSITIONS gate"
      pattern: "DESTRUCTIVE_TRANSITIONS\\.has"
    - from: "AlertDialog open"
      to: "pendingConfirm state"
      via: "controlled dialog"
      pattern: "pendingConfirm\\s*!==\\s*null"
---

<objective>
Add per-row workflow transition execution to AnalysisTable: API function, transition hook, state-aware action DropdownMenu, and AlertDialog for destructive actions.

Purpose: Lab staff need to submit, verify, retract, and reject individual analyses directly from the table. This plan builds all transition mechanics within AnalysisTable as a self-contained unit.

Output: Each analysis row has an Actions column with a context-sensitive dropdown menu. Non-destructive transitions execute immediately; destructive transitions require confirmation via AlertDialog. Per-row loading spinners prevent double-submit.
</objective>

<execution_context>
@C:\Users\forre\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\forre\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-per-row-workflow-transitions/07-RESEARCH.md

@src/lib/api.ts (lines 2105-2129 — AnalysisResultResponse interface and setAnalysisResult pattern)
@src/hooks/use-analysis-editing.ts (full file — hook structure to mirror)
@src/components/senaite/AnalysisTable.tsx (full file — adding Actions column)
@src/components/ui/dropdown-menu.tsx (DropdownMenuItem has variant="destructive" support)
@src/components/ui/alert-dialog.tsx (controlled mode via open prop)
</context>

<tasks>

<task type="auto">
  <name>Task 1: transitionAnalysis API function + useAnalysisTransition hook</name>
  <files>src/lib/api.ts, src/hooks/use-analysis-transition.ts</files>
  <action>
**In `src/lib/api.ts`** — Add `transitionAnalysis` function directly after `setAnalysisResult` (after line 2129). It mirrors the `setAnalysisResult` pattern exactly:

```typescript
export async function transitionAnalysis(
  uid: string,
  transition: 'submit' | 'verify' | 'retract' | 'reject'
): Promise<AnalysisResultResponse> {
  const response = await fetch(
    `${API_BASE_URL()}/wizard/senaite/analyses/${encodeURIComponent(uid)}/transition`,
    {
      method: 'POST',
      headers: getBearerHeaders('application/json'),
      body: JSON.stringify({ transition }),
    }
  )
  if (!response.ok) {
    const err = await response.json().catch(() => null)
    throw new Error(err?.detail || `Transition failed: ${response.status}`)
  }
  return response.json()
}
```

Reuses the existing `AnalysisResultResponse` interface (success, message, new_review_state, keyword). No new types needed.

**Create `src/hooks/use-analysis-transition.ts`** — New hook mirroring `use-analysis-editing.ts` structure:

- `pendingUids: Set<string>` — tracks which rows have in-flight transitions (NOT a single boolean — each row independently lockable)
- `pendingConfirm: { uid: string; transition: string; analysisTitle: string } | null` — drives the controlled AlertDialog
- `executeTransition(uid, transition)` — calls transitionAnalysis, manages pendingUids, shows toast, calls onTransitionComplete on success
- `requestConfirm(uid, transition, analysisTitle)` — sets pendingConfirm to open AlertDialog
- `cancelConfirm()` — clears pendingConfirm
- `confirmAndExecute()` — reads pendingConfirm, clears it, calls executeTransition

Hook accepts `{ onTransitionComplete?: () => void }` options object (same pattern as useAnalysisEditing).

Import TRANSITION_LABELS from AnalysisTable.tsx (or define locally — prefer local since the hook should not depend on a component). Define `TRANSITION_LABELS` as a local constant in the hook file:
```typescript
const TRANSITION_LABELS: Record<string, string> = {
  submit: 'Submit',
  verify: 'Verify',
  retract: 'Retract',
  reject: 'Reject',
}
```

Use `toast.success` / `toast.error` from sonner for feedback. On `response.success === false` (SENAITE silent rejection caught by backend), show `toast.error` with `response.message` as description.

Export the hook and its return type interface.
  </action>
  <verify>
    - `npx tsc --noEmit` passes (no type errors)
    - `transitionAnalysis` is exported from api.ts
    - `useAnalysisTransition` is exported from the new hook file
    - Hook file imports `transitionAnalysis` from `@/lib/api`
  </verify>
  <done>
    - transitionAnalysis function exists in api.ts, mirrors setAnalysisResult pattern, calls POST /wizard/senaite/analyses/{uid}/transition
    - useAnalysisTransition hook exists with pendingUids (Set), pendingConfirm (object|null), executeTransition, requestConfirm, cancelConfirm, confirmAndExecute
    - Both compile without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Actions column with DropdownMenu + AlertDialog in AnalysisTable</name>
  <files>src/components/senaite/AnalysisTable.tsx</files>
  <action>
**Add constants** at top of AnalysisTable.tsx (after EDITABLE_STATES):

```typescript
/** Maps review_state to valid transition action names. */
const ALLOWED_TRANSITIONS: Record<string, readonly string[]> = {
  unassigned: ['submit'],
  to_be_verified: ['verify', 'retract', 'reject'],
  verified: ['retract'],
}

const TRANSITION_LABELS: Record<string, string> = {
  submit: 'Submit',
  verify: 'Verify',
  retract: 'Retract',
  reject: 'Reject',
}

const DESTRUCTIVE_TRANSITIONS = new Set(['retract', 'reject'])
```

**Add imports** at top of file:
- `MoreHorizontal` from `lucide-react`
- `DropdownMenu, DropdownMenuContent, DropdownMenuItem, DropdownMenuTrigger` from `@/components/ui/dropdown-menu`
- `AlertDialog, AlertDialogAction, AlertDialogCancel, AlertDialogContent, AlertDialogDescription, AlertDialogFooter, AlertDialogHeader, AlertDialogTitle` from `@/components/ui/alert-dialog`
- `useAnalysisTransition, type UseAnalysisTransitionReturn` from `@/hooks/use-analysis-transition`

**Update AnalysisTableProps interface** — add optional `onTransitionComplete` callback:
```typescript
interface AnalysisTableProps {
  analyses: SenaiteAnalysis[]
  analyteNameMap: Map<number, string>
  onResultSaved?: (uid: string, newResult: string, newReviewState: string | null) => void
  onTransitionComplete?: () => void
}
```

**In AnalysisTable component body** — instantiate the transition hook:
```typescript
const transition = useAnalysisTransition({ onTransitionComplete })
```

**Update AnalysisRow** — add `transition: UseAnalysisTransitionReturn` prop. Add an Actions `<td>` as the LAST column (after the Captured column). The cell contains:

- If the analysis has a uid AND has allowed transitions for its review_state: render a DropdownMenu
- DropdownMenuTrigger is a small icon button (MoreHorizontal icon, 14px). When `pendingUids.has(uid)`, show Spinner instead and disable the button.
- DropdownMenuContent aligned `"end"`. Each allowed transition is a DropdownMenuItem.
- Destructive transitions (retract, reject) use `variant="destructive"` on the DropdownMenuItem.
- onClick: if DESTRUCTIVE_TRANSITIONS.has(t), call `transition.requestConfirm(uid, t, analysis.title)`; otherwise call `transition.executeTransition(uid, t)`.
- If no transitions available or no uid: render an empty `<td>` (keeps column alignment).

**Add Actions header** — add a 9th `<th>` in the thead after "Captured":
```html
<th className="py-2 px-3 text-right text-[11px] font-semibold text-muted-foreground uppercase tracking-wider w-12">
  <span className="sr-only">Actions</span>
</th>
```

**Update colSpan** in the empty-state `<td>` from 8 to 9.

**Add AlertDialog** — place OUTSIDE the `<table>` element (after the closing `</table>` tag, still inside the overflow wrapper div). Use controlled mode:
```tsx
<AlertDialog open={transition.pendingConfirm !== null} onOpenChange={(open) => {
  if (!open) transition.cancelConfirm()
}}>
  <AlertDialogContent>
    <AlertDialogHeader>
      <AlertDialogTitle>
        {transition.pendingConfirm?.transition === 'retract' ? 'Retract analysis?' : 'Reject analysis?'}
      </AlertDialogTitle>
      <AlertDialogDescription>
        <strong>{transition.pendingConfirm?.analysisTitle}</strong> will be{' '}
        {transition.pendingConfirm?.transition === 'retract'
          ? 'retracted back to unassigned state'
          : 'permanently rejected'}.
        This action cannot be undone from this application.
      </AlertDialogDescription>
    </AlertDialogHeader>
    <AlertDialogFooter>
      <AlertDialogCancel>Cancel</AlertDialogCancel>
      <AlertDialogAction
        className="bg-destructive text-destructive-foreground hover:bg-destructive/90"
        onClick={transition.confirmAndExecute}
      >
        Confirm {transition.pendingConfirm?.transition}
      </AlertDialogAction>
    </AlertDialogFooter>
  </AlertDialogContent>
</AlertDialog>
```

IMPORTANT: The AlertDialog MUST be outside the `<table>` element to avoid DOM nesting issues. Place it after the table's closing tag but before the Card's closing tag.

**Pass transition prop to AnalysisRow** in the map call:
```tsx
<AnalysisRow
  key={a.uid ?? `${a.title}-${i}`}
  analysis={a}
  analyteNameMap={analyteNameMap}
  editing={editing}
  transition={transition}
/>
```

Note: The `onTransitionComplete` callback is optional — Plan 02 will wire it from SampleDetails. For now, transitions will execute and show toasts but the table data will not auto-refresh (the user would need to manually reload). This is the correct intermediate state.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - AnalysisTable.tsx has 9 column headers (including sr-only Actions)
    - ALLOWED_TRANSITIONS constant maps unassigned->['submit'], to_be_verified->['verify','retract','reject'], verified->['retract']
    - AlertDialog is outside the `<table>` element (grep for AlertDialog and verify its position relative to `</table>`)
    - DropdownMenu imports are present
    - `npm run build` succeeds
  </verify>
  <done>
    - Every analysis row with a valid review_state shows an action DropdownMenu with only valid transitions
    - Destructive actions (retract, reject) gate through a confirmation AlertDialog
    - Non-destructive actions (submit, verify) execute immediately
    - Per-row spinner replaces the MoreHorizontal icon during in-flight transitions
    - colSpan updated to 9 for empty state
    - AlertDialog lives outside table element, controlled by pendingConfirm state
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` — zero type errors
2. `npm run build` — production build succeeds
3. In AnalysisTable.tsx: `ALLOWED_TRANSITIONS['unassigned']` returns `['submit']`
4. In AnalysisTable.tsx: `ALLOWED_TRANSITIONS['to_be_verified']` returns `['verify', 'retract', 'reject']`
5. In AnalysisTable.tsx: `ALLOWED_TRANSITIONS['verified']` returns `['retract']`
6. In AnalysisTable.tsx: AlertDialog is positioned after `</table>` (not nested inside)
7. In api.ts: `transitionAnalysis` function exists and calls the correct endpoint
8. In use-analysis-transition.ts: hook exports pendingUids as Set<string>
</verification>

<success_criteria>
- Requirements WKFL-01 (state-aware action menu), WKFL-06 (confirmation dialog for destructive), WKFL-07 (per-row loading spinner) are implemented
- Requirements WKFL-02 through WKFL-05 (actual transition execution) are wired — the execute path works, but without sample-level refresh (Plan 02)
- All code compiles and builds without errors
- The transition hook follows the same structural pattern as useAnalysisEditing
</success_criteria>

<output>
After completion, create `.planning/phases/07-per-row-workflow-transitions/07-01-SUMMARY.md`
</output>
