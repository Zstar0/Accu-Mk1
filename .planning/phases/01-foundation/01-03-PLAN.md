---
phase: 01-foundation
plan: 03
type: fix
wave: 3
depends_on: ["01-02"]
files_modified: [src-tauri/tauri.conf.json, src/App.tsx, src-tauri/capabilities/default.json]
autonomous: true
fixes_gaps:
  - "Frontend can communicate with backend in Tauri mode"
must_haves:
  truths:
    - "CSP allows connections to http://127.0.0.1:8008"
    - "Frontend demonstrates backend communication"
  artifacts:
    - path: "src-tauri/capabilities/default.json"
      provides: "CSP configuration with backend URL"
      contains: "127.0.0.1:8008"
    - path: "src/App.tsx"
      provides: "React component calling backend"
      contains: "healthCheck"
---

<objective>
Fix CSP to allow backend communication and wire API client into frontend.

Purpose: Complete the browser-mode dual-mode goal by enabling frontend-backend communication.
Output: Frontend can fetch from backend, health status displays in UI.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-VERIFICATION.md

Gap being fixed:
- CSP blocks connections to localhost:8008
- API client (src/lib/api.ts) not wired into components

NOTE: Sidecar integration deferred - requires PyInstaller setup which is separate concern.
Browser mode connectivity is the priority for phase 1.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix CSP to allow backend connections</name>
  <files>src-tauri/capabilities/default.json</files>
  <action>
    Update Tauri v2 capabilities to allow HTTP connections to the backend.

    In Tauri v2, CSP is configured via capabilities, not tauri.conf.json directly.

    Read src-tauri/capabilities/default.json and add the http permission for the backend URL.

    The key change: ensure the capability allows HTTP/fetch to http://127.0.0.1:8008.

    For Tauri v2, this typically means:
    1. Check if http:default permission is in the permissions array
    2. Add configuration for allowed URLs

    Reference Tauri v2 docs for exact capability format.
  </action>
  <verify>
    - Capabilities file updated
    - Backend URL is allowed for HTTP requests
  </verify>
  <done>CSP/capabilities updated to allow backend communication</done>
</task>

<task type="auto">
  <name>Task 2: Wire API client into App component</name>
  <files>src/App.tsx</files>
  <action>
    Update App.tsx to demonstrate backend communication:

    1. Import healthCheck from src/lib/api.ts
    2. Add a useEffect that calls healthCheck() on mount
    3. Display connection status in the UI:
       - Loading: "Connecting to backend..."
       - Success: "Backend connected (v{version})"
       - Error: "Backend offline - start with: uvicorn backend.main:app"

    Keep the existing MainWindow content, just add a status indicator.

    Use React state (useState) for the connection status - this is local component state.
  </action>
  <verify>
    - App.tsx imports healthCheck
    - useEffect calls backend on mount
    - UI shows connection status
    - TypeScript compiles without errors
  </verify>
  <done>API client wired into frontend, health status displays</done>
</task>

<task type="auto">
  <name>Task 3: Verify end-to-end communication</name>
  <files>none</files>
  <action>
    Test the full flow:

    1. Start backend: cd backend && uvicorn main:app --host 127.0.0.1 --port 8008
    2. Start frontend: npm run dev
    3. Open http://localhost:1420 in browser
    4. Verify UI shows "Backend connected (v0.1.0)"
    5. Stop backend, refresh browser
    6. Verify UI shows offline message

    This verifies browser mode works. Tauri mode with sidecar is Phase 2 scope.
  </action>
  <verify>
    - Browser shows backend connected when backend running
    - Browser shows offline message when backend stopped
    - No CORS or CSP errors in console
  </verify>
  <done>End-to-end browser mode communication verified</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] CSP/capabilities allow http://127.0.0.1:8008
- [ ] App.tsx imports and calls healthCheck
- [ ] UI displays backend connection status
- [ ] npm run dev + browser shows connected status (with backend running)
- [ ] No TypeScript errors
</verification>

<success_criteria>
- Frontend successfully fetches from backend in browser mode
- Connection status visible in UI
- No CORS/CSP errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-03-SUMMARY.md`
</output>
