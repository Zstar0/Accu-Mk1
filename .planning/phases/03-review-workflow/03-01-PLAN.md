---
wave: 1
autonomous: true
---

# Phase 3 Plan 1: Sample Review Backend

**Summary**: Add sample status lifecycle (pending → calculated → approved/rejected) and API endpoints for approving/rejecting samples with reasons.

## Goal Backward

**Phase Goal**: Operator can review batch, approve/reject samples, filter/sort results

**This Plan Must Deliver**:
- Sample status field supports: pending, calculated, approved, rejected
- API endpoint to approve a sample
- API endpoint to reject a sample with reason/comment
- Rejection reason stored on sample record

## Must-Haves (What Must Be TRUE)

### Truths
- Sample.status can be: pending, calculated, approved, rejected
- Sample has rejection_reason field (nullable)
- Approving sample sets status="approved"
- Rejecting sample sets status="rejected" and stores reason
- Status changes logged to audit trail

### Artifacts
- `backend/models.py`: Sample model with rejection_reason field
- `backend/main.py`: PUT /samples/{id}/approve and PUT /samples/{id}/reject endpoints
- `src/lib/api.ts`: approveSample() and rejectSample() functions

### Key Links
- PUT /samples/{id}/approve → Sample.status = "approved"
- PUT /samples/{id}/reject (body: {reason}) → Sample.status = "rejected", Sample.rejection_reason = reason
- Both endpoints create AuditLog entry

## Tasks

### Task 1: Add rejection_reason to Sample model

**Objective**: Extend Sample model with rejection_reason field

**Checklist**:
- [ ] Add rejection_reason: Mapped[Optional[str]] to Sample model
- [ ] Verify existing Sample queries still work

**Commit**: `feat(03-01): add rejection_reason field to Sample model`

### Task 2: Create approve/reject API endpoints

**Objective**: Backend endpoints for sample approval workflow

**Checklist**:
- [ ] PUT /samples/{id}/approve - sets status="approved", clears rejection_reason, creates audit log
- [ ] PUT /samples/{id}/reject - accepts reason in body, sets status="rejected" and rejection_reason, creates audit log
- [ ] Both return updated sample
- [ ] Return 404 if sample not found

**Commit**: `feat(03-01): add sample approve and reject endpoints`

### Task 3: Add TypeScript API client functions

**Objective**: Frontend can call approve/reject APIs

**Checklist**:
- [ ] Add approveSample(sampleId: number) function
- [ ] Add rejectSample(sampleId: number, reason: string) function
- [ ] Update Sample interface to include rejection_reason

**Commit**: `feat(03-01): add approveSample and rejectSample API functions`

## Verification

```bash
# Approve a sample
curl -X PUT http://127.0.0.1:8009/samples/1/approve

# Reject a sample with reason
curl -X PUT http://127.0.0.1:8009/samples/2/reject \
  -H "Content-Type: application/json" \
  -d '{"reason": "Peak integration failed"}'

# Verify status changed
curl http://127.0.0.1:8009/samples/1
curl http://127.0.0.1:8009/samples/2
```

## Dependencies

- Requires: Phase 2 (Sample model exists)
- Provides: Approve/reject API for UI integration
- Affects: 03-02, 03-03

## Scope

- Tasks: 3
- Estimated context: 30%
