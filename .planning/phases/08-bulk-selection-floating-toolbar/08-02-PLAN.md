---
phase: 08-bulk-selection-floating-toolbar
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - src/components/senaite/AnalysisTable.tsx
autonomous: true

must_haves:
  truths:
    - "User can check individual analysis rows via a checkbox in the first column"
    - "Header checkbox toggles select-all/deselect-all for visible (filtered) analyses only"
    - "Header checkbox shows indeterminate state when some but not all visible rows are selected"
    - "A floating toolbar appears between filter tabs and table when any rows are selected"
    - "Toolbar shows selection count and batch action buttons"
    - "Batch action buttons only show transitions valid for ALL selected analyses"
    - "Selecting mixed states (e.g. unassigned + verified) hides Submit and Verify from toolbar"
    - "Destructive bulk actions (retract, reject) show AlertDialog confirmation before executing"
    - "During bulk processing, toolbar shows progress counter ('Submitting 2/5...') instead of action buttons"
    - "After bulk operations complete, sample-level progress bar and status badge update via single refresh"
    - "Toolbar is disabled when a per-row transition is in-flight (pendingUids.size > 0)"
  artifacts:
    - path: "src/components/senaite/AnalysisTable.tsx"
      provides: "Checkbox column, BulkActionToolbar, bulk processing integration"
      contains: "useBulkAnalysisTransition"
  key_links:
    - from: "src/components/senaite/AnalysisTable.tsx"
      to: "src/hooks/use-bulk-analysis-transition.ts"
      via: "useBulkAnalysisTransition import and call"
      pattern: "useBulkAnalysisTransition"
    - from: "src/components/senaite/AnalysisTable.tsx"
      to: "src/components/ui/checkbox.tsx"
      via: "Checkbox import for header and row cells"
      pattern: "import.*Checkbox.*from.*checkbox"
    - from: "BulkActionToolbar (inline)"
      to: "executeBulk"
      via: "onClick handler on batch action buttons"
      pattern: "executeBulk"
---

<objective>
Wire checkbox selection and the bulk action toolbar into AnalysisTable, completing the full bulk selection and batch operations feature.

Purpose: This is the UI integration that delivers all four BULK requirements. Users can select analyses, see state-aware batch buttons, trigger bulk operations with progress feedback, and get a single sample refresh afterward.

Output: Fully functional AnalysisTable with checkbox column, floating toolbar, state-aware batch buttons, progress counter, destructive confirmation, and post-bulk refresh.
</objective>

<execution_context>
@C:\Users\forre\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\forre\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-bulk-selection-floating-toolbar/08-RESEARCH.md
@.planning/phases/08-bulk-selection-floating-toolbar/08-01-SUMMARY.md
@src/components/senaite/AnalysisTable.tsx
@src/hooks/use-bulk-analysis-transition.ts
@src/components/ui/checkbox.tsx
@src/components/senaite/SampleDetails.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add checkbox column and hook integration to AnalysisTable</name>
  <files>src/components/senaite/AnalysisTable.tsx</files>
  <action>
Wire the `useBulkAnalysisTransition` hook and add checkbox selection to the AnalysisTable. This is a single focused modification of AnalysisTable.tsx.

**Imports to add:**
- `import { Checkbox } from '@/components/ui/checkbox'`
- `import { Button } from '@/components/ui/button'`
- `import { useBulkAnalysisTransition } from '@/hooks/use-bulk-analysis-transition'`
- Add `Minus` to the lucide-react import (for any inline use if needed) -- actually not needed since Checkbox handles it internally now

**In the AnalysisTable component function:**

1. Call the bulk hook:
   ```typescript
   const bulk = useBulkAnalysisTransition({ onTransitionComplete })
   ```

2. Compute header checkbox state (from FILTERED analyses only, not all):
   ```typescript
   const selectableUids = filteredAnalyses
     .map(a => a.uid)
     .filter((uid): uid is string => !!uid)
   const allSelected = selectableUids.length > 0 &&
     selectableUids.every(uid => bulk.selectedUids.has(uid))
   const someSelected = selectableUids.some(uid => bulk.selectedUids.has(uid))
   const headerChecked: boolean | 'indeterminate' =
     allSelected ? true : someSelected ? 'indeterminate' : false
   ```

3. Compute bulk available actions (intersection of ALLOWED_TRANSITIONS for all selected):
   ```typescript
   const selectedAnalyses = analyses.filter(a => a.uid && bulk.selectedUids.has(a.uid))
   const bulkAvailableActions = (['submit', 'verify', 'retract', 'reject'] as const).filter(t =>
     selectedAnalyses.length > 0 &&
     selectedAnalyses.every(a =>
       a.review_state !== null &&
       a.review_state !== undefined &&
       (ALLOWED_TRANSITIONS[a.review_state] ?? []).includes(t)
     )
   )
   ```

4. Determine if toolbar should be disabled (per-row transition in flight):
   ```typescript
   const toolbarDisabled = transition.pendingUids.size > 0
   ```

**Table header -- add checkbox column as FIRST `<th>`:**
```tsx
<th className="py-2 px-3 w-10">
  <Checkbox
    checked={headerChecked}
    onCheckedChange={(checked) => {
      if (checked === true) {
        bulk.selectAll(selectableUids)
      } else {
        bulk.clearSelection()
      }
    }}
    disabled={bulk.isBulkProcessing || toolbarDisabled}
    aria-label="Select all analyses"
  />
</th>
```

**AnalysisRow -- add checkbox cell as FIRST `<td>`:**
Add `selectedUids` and `onToggleSelection` props to AnalysisRow. In the row component:
```tsx
<td className="py-2.5 px-3">
  {analysis.uid && (
    <Checkbox
      checked={bulk.selectedUids.has(analysis.uid)}
      onCheckedChange={() => { if (analysis.uid) onToggleSelection(analysis.uid) }}
      disabled={isBulkProcessing}
      aria-label={`Select ${analysis.title}`}
    />
  )}
</td>
```

Pass these props from the parent map:
- `selectedUids={bulk.selectedUids}`
- `onToggleSelection={bulk.toggleSelection}`
- `isBulkProcessing={bulk.isBulkProcessing}`

Update AnalysisRow interface to accept: `selectedUids: Set<string>`, `onToggleSelection: (uid: string) => void`, `isBulkProcessing: boolean`.

**Update colSpan from 9 to 10:** Find `colSpan={9}` in the empty state `<td>` and change to `colSpan={10}`.

**Add BulkActionToolbar between progress bar and table:**
Render a `BulkActionToolbar` inline component (defined as a local function in the same file, like TabButton) when `bulk.selectedUids.size > 0`. Place it between the `</div>` of the progress bar section and the `<div className="overflow-x-auto...">` table wrapper.

```tsx
{bulk.selectedUids.size > 0 && (
  <div className="flex items-center justify-between px-3 py-2 mb-2 rounded-lg bg-primary/5 border border-primary/20">
    <div className="flex items-center gap-3">
      <span className="text-sm font-medium text-foreground">
        {bulk.selectedUids.size} selected
      </span>
      <button
        onClick={bulk.clearSelection}
        className="text-xs text-muted-foreground hover:text-foreground underline underline-offset-2 cursor-pointer"
      >
        Clear
      </button>
    </div>
    <div className="flex items-center gap-2">
      {bulk.isBulkProcessing && bulk.bulkProgress ? (
        <div className="flex items-center gap-2">
          <Spinner className="size-3.5" />
          <span className="text-sm text-muted-foreground">
            {TRANSITION_LABELS[bulk.bulkProgress.transition] ?? bulk.bulkProgress.transition}ing{' '}
            {bulk.bulkProgress.current}/{bulk.bulkProgress.total}...
          </span>
        </div>
      ) : (
        bulkAvailableActions.map(t => (
          <Button
            key={t}
            size="sm"
            variant={DESTRUCTIVE_TRANSITIONS.has(t) ? 'destructive' : 'default'}
            disabled={toolbarDisabled}
            onClick={() => {
              if (DESTRUCTIVE_TRANSITIONS.has(t)) {
                // Set bulk pending confirm state for AlertDialog
                setBulkPendingConfirm({ transition: t, count: bulk.selectedUids.size })
              } else {
                void bulk.executeBulk([...bulk.selectedUids], t)
              }
            }}
          >
            {TRANSITION_LABELS[t] ?? t} selected
          </Button>
        ))
      )}
      {bulkAvailableActions.length === 0 && !bulk.isBulkProcessing && (
        <span className="text-xs text-muted-foreground italic">
          No common actions for selection
        </span>
      )}
    </div>
  </div>
)}
```

**Add AlertDialog for destructive BULK operations:**
Add a `bulkPendingConfirm` state: `useState<{ transition: string; count: number } | null>(null)`

Add a second AlertDialog (after the existing per-row one) for bulk destructive confirmation:

```tsx
<AlertDialog
  open={bulkPendingConfirm !== null}
  onOpenChange={(open) => { if (!open) setBulkPendingConfirm(null) }}
>
  <AlertDialogContent>
    <AlertDialogHeader>
      <AlertDialogTitle>
        {bulkPendingConfirm?.transition === 'retract'
          ? `Retract ${bulkPendingConfirm.count} analyses?`
          : `Reject ${bulkPendingConfirm.count} analyses?`}
      </AlertDialogTitle>
      <AlertDialogDescription>
        {bulkPendingConfirm?.count} analyses will be{' '}
        {bulkPendingConfirm?.transition === 'retract'
          ? 'retracted back to unassigned state'
          : 'permanently rejected'}
        . This action cannot be undone from this application.
      </AlertDialogDescription>
    </AlertDialogHeader>
    <AlertDialogFooter>
      <AlertDialogCancel>Cancel</AlertDialogCancel>
      <AlertDialogAction
        className="bg-destructive text-destructive-foreground hover:bg-destructive/90"
        onClick={() => {
          if (bulkPendingConfirm) {
            void bulk.executeBulk([...bulk.selectedUids], bulkPendingConfirm.transition)
          }
          setBulkPendingConfirm(null)
        }}
      >
        Confirm {bulkPendingConfirm?.transition}
      </AlertDialogAction>
    </AlertDialogFooter>
  </AlertDialogContent>
</AlertDialog>
```

Place this AlertDialog after the existing per-row AlertDialog, still inside the Card but outside the `<table>` for valid DOM nesting.

**Summary of all changes to AnalysisTable.tsx:**
1. New imports: Checkbox, Button, useBulkAnalysisTransition
2. New state: bulkPendingConfirm
3. Hook call: useBulkAnalysisTransition({ onTransitionComplete })
4. Computed values: selectableUids, headerChecked, selectedAnalyses, bulkAvailableActions, toolbarDisabled
5. Header row: new checkbox `<th>` as first column
6. AnalysisRow: new props + checkbox `<td>` as first cell
7. Toolbar: conditional inline render between progress bar and table
8. AlertDialog: bulk destructive confirmation
9. colSpan: 9 -> 10
  </action>
  <verify>
Run `npm run check:all` to confirm no TypeScript or lint errors.

Manual verification checklist (ask user to run dev server):
1. Open Sample Details page with analyses
2. Verify checkbox column appears as first column in the table
3. Click individual row checkboxes — toolbar appears with count
4. Click header checkbox — all visible rows selected, toolbar shows correct count
5. With "Pending" filter active, header checkbox only selects pending rows
6. Select all unassigned analyses — toolbar shows "Submit selected" button
7. Select mix of unassigned + verified — toolbar shows no common actions message
8. Click "Submit selected" — progress counter advances ("Submitting 1/5...")
9. After completion — summary toast appears, selections cleared, progress bar updates
10. Select verified analyses, click "Retract selected" — AlertDialog appears before execution
  </verify>
  <done>
AnalysisTable renders checkbox column (header + per-row), floating toolbar with selection count and state-aware batch buttons, progress counter during bulk processing, AlertDialog for destructive bulk, and colSpan correctly set to 10. All four BULK requirements (BULK-01 through BULK-04) are satisfied.
  </done>
</task>

</tasks>

<verification>
- `npm run check:all` passes with no errors
- AnalysisTable.tsx imports and calls `useBulkAnalysisTransition`
- AnalysisTable.tsx imports `Checkbox` from `@/components/ui/checkbox`
- Header `<th>` contains `<Checkbox>` with indeterminate logic
- AnalysisRow renders checkbox `<td>` as first cell
- colSpan is 10 (not 9) in empty state row
- BulkActionToolbar renders conditionally when `selectedUids.size > 0`
- bulkAvailableActions uses intersection logic with ALLOWED_TRANSITIONS
- Destructive bulk transitions gate through AlertDialog
- Toolbar disabled when `transition.pendingUids.size > 0`
- Progress text renders during `isBulkProcessing` state
</verification>

<success_criteria>
1. Checkbox column visible in analysis table with header indeterminate support
2. Floating toolbar appears with selection count when rows are selected
3. Batch action buttons only show transitions valid for ALL selected rows
4. Destructive bulk transitions (retract/reject) show confirmation dialog
5. Progress counter visible during bulk processing ("Submitting 2/5...")
6. Summary toast appears after bulk operation completes
7. Sample-level progress bar and status badge update after bulk operations (single refresh)
8. Toolbar disabled during in-flight per-row transitions
</success_criteria>

<output>
After completion, create `.planning/phases/08-bulk-selection-floating-toolbar/08-02-SUMMARY.md`
</output>
