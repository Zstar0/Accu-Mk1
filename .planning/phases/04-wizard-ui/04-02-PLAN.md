---
phase: 04-wizard-ui
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/components/hplc/CreateAnalysis.tsx
  - src/components/hplc/wizard/steps/Step1SampleInfo.tsx
  - src/components/hplc/wizard/steps/Step2StockPrep.tsx
  - src/components/hplc/wizard/steps/Step3Dilution.tsx
autonomous: true

must_haves:
  truths:
    - "Tech enters target concentration and total volume in Step 1 and creates a session"
    - "Step 2 instructs tech to weigh empty vial, transfer peptide, shows diluent volume, captures loaded vial weight"
    - "Step 3 instructs tech to weigh empty dilution vial, add diluent then re-weigh, add stock then weigh final"
    - "Calculated values (stock_conc, required volumes, actual_conc) display inline after weights are accepted"
  artifacts:
    - path: "src/components/hplc/wizard/steps/Step1SampleInfo.tsx"
      provides: "Session creation form with peptide dropdown, sample ID, declared weight, target params"
    - path: "src/components/hplc/wizard/steps/Step2StockPrep.tsx"
      provides: "Stock prep step with 4 sub-steps: empty vial weight, peptide transfer confirm, diluent volume display, loaded vial weight"
    - path: "src/components/hplc/wizard/steps/Step3Dilution.tsx"
      provides: "Dilution step with 3 weighing sub-steps and inline calculated volume displays"
  key_links:
    - from: "src/components/hplc/wizard/steps/Step1SampleInfo.tsx"
      to: "src/lib/api.ts"
      via: "createWizardSession on form submit"
      pattern: "createWizardSession"
    - from: "src/components/hplc/wizard/steps/Step2StockPrep.tsx"
      to: "src/components/hplc/WeightInput.tsx"
      via: "WeightInput for stock_vial_empty_mg and stock_vial_loaded_mg"
      pattern: "WeightInput"
    - from: "src/components/hplc/wizard/steps/Step2StockPrep.tsx"
      to: "src/lib/api.ts"
      via: "recordWizardMeasurement on weight accept"
      pattern: "recordWizardMeasurement"
    - from: "src/components/hplc/wizard/steps/Step3Dilution.tsx"
      to: "src/components/hplc/WeightInput.tsx"
      via: "WeightInput for dil_vial_empty_mg, dil_vial_with_diluent_mg, dil_vial_final_mg"
      pattern: "WeightInput"
---

<objective>
Implement wizard Steps 1-3: the session creation form (Sample Info), Stock Prep (4 weighing sub-steps with calculated outputs), and Dilution (3 weighing sub-steps with inline volume displays). Wire all steps to the backend API via the wizard store and WeightInput component.

Purpose: These 3 steps cover the core lab workflow — from session creation through all sample preparation weighing. After this plan, the tech can complete the entire physical prep process through the wizard.
Output: Functional Steps 1-3 that create sessions, capture weights, and display calculated values inline.
</objective>

<execution_context>
@C:\Users\forre\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\forre\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-wizard-ui/04-RESEARCH.md
@.planning/phases/04-wizard-ui/04-01-SUMMARY.md
@src/store/wizard-store.ts
@src/lib/api.ts
@src/components/hplc/WeightInput.tsx
@src/components/hplc/CreateAnalysis.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Step1SampleInfo — session creation form</name>
  <files>src/components/hplc/wizard/steps/Step1SampleInfo.tsx</files>
  <action>
Create `src/components/hplc/wizard/steps/Step1SampleInfo.tsx`:

This is the WizardStartForm that creates a session on submit.

**Form fields:**
1. **Peptide** (required) — dropdown/select populated from `GET /peptides` (use existing `getPeptides()` from api.ts). Show peptide name + abbreviation. Value is `peptide_id: number`.
2. **Sample ID Label** (optional) — text input, freeform
3. **Declared Weight (mg)** (optional) — number input, step="0.01", placeholder "e.g. 10.00"
4. **Target Concentration (ug/mL)** (required for step unlock) — number input, step="0.1", placeholder "e.g. 1200"
5. **Target Total Volume (uL)** (required for step unlock) — number input, step="0.1", placeholder "e.g. 1200"

**Behavior:**
- Use local component state for form fields (NOT wizard store — form is transient until submit)
- On submit: call `createWizardSession({ peptide_id, sample_id_label, declared_weight_mg, target_conc_ug_ml, target_total_vol_ul })` from api.ts
- On success: call `useWizardStore.getState().startSession(response)` then `useWizardStore.getState().setCurrentStep(2)` to advance
- Show loading spinner on submit button while request is in flight
- Show error message (toast via sonner or inline Alert) if POST returns 400 (no active calibration) or other error
- Disable submit if peptide_id is not selected

**If session already exists** (user navigated back to Step 1):
- Show the session data as read-only summary (peptide name, sample ID, declared weight, targets)
- Do NOT show the form again — session is already created
- Check via `useWizardStore(state => state.session)` — if not null, render read-only view

**UI components:** Use shadcn/ui `Select` for peptide dropdown (existing in project), `Input` for text/number fields, `Button` for submit, `Label` for field labels. Wrap in a `Card` with header "Sample Information".

Load peptides on mount with useEffect + local state (not TanStack Query — matches codebase pattern in other components like PeptideConfig.tsx). Handle loading and error states.
  </action>
  <verify>
- `npx tsc --noEmit` passes
- Step 1 renders the form with peptide dropdown, all input fields, and submit button
- After creating a session, store.session is populated and wizard advances to Step 2
- Navigating back to Step 1 shows read-only session summary (not the form again)
  </verify>
  <done>
- Tech can select peptide, enter target concentration and total volume, create session
- Session creation calls POST /wizard/sessions and updates wizard store
- Wizard auto-advances to Step 2 after successful session creation
- Revisiting Step 1 shows read-only data summary
- SMP-04 requirement satisfied (target_conc_ug_ml + target_total_vol_ul input)
  </done>
</task>

<task type="auto">
  <name>Task 2: Step2StockPrep and Step3Dilution — weighing steps</name>
  <files>src/components/hplc/wizard/steps/Step2StockPrep.tsx, src/components/hplc/wizard/steps/Step3Dilution.tsx, src/components/hplc/CreateAnalysis.tsx</files>
  <action>
**1. Create `src/components/hplc/wizard/steps/Step2StockPrep.tsx`** — Stock Preparation step:

Displays sub-steps in sequential order. Each sub-step unlocks when the previous one is complete. Read session from `useWizardStore(state => state.session)`.

Sub-steps (rendered as a vertical list of cards/sections):

**Sub-step 2a: Empty vial weight (STK-01)**
- Instruction text: "Weigh the empty sample vial with cap"
- Render `<WeightInput stepKey="stock_vial_empty_mg" label="Empty vial + cap weight (mg)" onAccept={handler} />`
- `onAccept` handler: call `recordWizardMeasurement(session.id, { step_key: 'stock_vial_empty_mg', weight_mg: value, source })` then `useWizardStore.getState().updateSession(response)`
- After accepted: show the accepted value as a read-only display with a "Re-weigh" button that resets and shows WeightInput again
- Check if measurement already exists in `session.measurements` for this step_key — if so, show accepted value with Re-weigh button

**Sub-step 2b: Peptide transfer confirmation (STK-02)**
- Locked until sub-step 2a is complete (stock_vial_empty_mg measurement exists)
- Instruction text: "Transfer the peptide sample to the vial"
- NO WeightInput — just a confirmation: `<Button onClick={handleConfirm}>I have transferred the peptide</Button>`
- After confirmed: show green check + "Peptide transferred" text
- Store confirmation in local state (or derive from: if stock_vial_loaded_mg measurement exists, transfer was implicitly confirmed)
- Use local component state for "confirmed" boolean — this is transient UI state

**Sub-step 2c: Display required diluent volume (STK-03)**
- Locked until sub-step 2b is confirmed
- Read `session.calculations?.required_diluent_vol_ul` — if available, display: "Add {X} uL of diluent to the vial"
- If not yet available (waiting for stock_conc calculation): show a note "Diluent volume will be calculated after vial weights are recorded"
- This is display-only — no user input

**Sub-step 2d: Loaded vial weight (STK-04)**
- Locked until sub-step 2b is confirmed
- Instruction text: "Add the diluent, then weigh the vial + cap + diluent"
- Render `<WeightInput stepKey="stock_vial_loaded_mg" label="Vial + cap + diluent weight (mg)" onAccept={handler} />`
- Same onAccept pattern as 2a: call recordWizardMeasurement, updateSession
- After accepted: show accepted value with Re-weigh button

**After all sub-steps complete:**
- Display inline calculated values from `session.calculations`:
  - `stock_conc_ug_ml` — "Stock Concentration: {X} ug/mL"
  - `required_stock_vol_ul` — "Required Stock Volume: {X} uL"
  - `required_diluent_vol_ul` — "Required Diluent Volume: {X} uL"
- Show as a summary card with green accent border

**2. Create `src/components/hplc/wizard/steps/Step3Dilution.tsx`** — Dilution step:

Same sequential sub-step pattern as Step 2. Read session from wizard store.

**IMPORTANT: Step3Dilution.tsx follows the identical sub-step locking pattern as Step2StockPrep.tsx** — for each sub-step, check if the measurement exists in `session.measurements` via `find(m => m.step_key === 'key')`. If measurement exists, sub-step is "done" (show value + Re-weigh). If not and previous sub-step is done, sub-step is "active" (show WeightInput). If previous sub-step is not done, sub-step is "locked" (show disabled/grayed out). Replicate this pattern consistently between both step components.

**Display (top of step):**
- Show required volumes from calculations:
  - "Required Diluent Volume: {session.calculations?.required_diluent_vol_ul} uL"
  - "Required Stock Volume: {session.calculations?.required_stock_vol_ul} uL"

**Sub-step 3a: Empty dilution vial weight (DIL-02)**
- Instruction: "Weigh the empty dilution vial with cap"
- `<WeightInput stepKey="dil_vial_empty_mg" label="Empty dilution vial + cap weight (mg)" onAccept={handler} />`
- Same record/update pattern

**Sub-step 3b: Vial + diluent weight (DIL-03)**
- Locked until 3a complete
- Instruction: "Add {required_diluent_vol_ul} uL of diluent, then re-weigh"
- `<WeightInput stepKey="dil_vial_with_diluent_mg" label="Vial + cap + diluent weight (mg)" onAccept={handler} />`

**Sub-step 3c: Final dilution vial weight (DIL-04)**
- Locked until 3b complete
- Instruction: "Add {required_stock_vol_ul} uL of stock solution, then weigh"
- `<WeightInput stepKey="dil_vial_final_mg" label="Final dilution vial weight (mg)" onAccept={handler} />`

**After all sub-steps complete:**
- Display from `session.calculations`:
  - `actual_diluent_vol_ul` — "Actual Diluent Added: {X} uL"
  - `actual_stock_vol_ul` — "Actual Stock Added: {X} uL"
  - `actual_conc_ug_ml` — "Actual Concentration: {X} ug/mL"
- Show as summary card with green accent

**3. Update `src/components/hplc/CreateAnalysis.tsx`** — Replace Step 1-3 placeholders:

In the `renderCurrentStep()` switch, replace placeholder divs:
- case 1: `<Step1SampleInfo />`
- case 2: `<Step2StockPrep />`
- case 3: `<Step3Dilution />`

Import the three components from `@/components/hplc/wizard/steps/`.

Keep placeholders for steps 4 and 5 — those are in Plan 04-03.

**Sub-step locking logic pattern** (same for both steps):
Check if the measurement for the previous sub-step exists in `session.measurements.find(m => m.step_key === 'xxx')`. If measurement exists, sub-step is "done" (show value + Re-weigh). If not, sub-step is "active" (show WeightInput). If previous sub-step is not done, sub-step is "locked" (show disabled/grayed out).

**CRITICAL architecture rules:**
- Use `useWizardStore(state => state.session)` selector syntax — NO destructuring
- Use `useWizardStore.getState().updateSession(response)` in callbacks
- Import WeightInput from `@/components/hplc/WeightInput`
- React Compiler handles memoization — NO manual useMemo/useCallback
- Format displayed numbers with `.toFixed(2)` for weights, `.toFixed(1)` for volumes
  </action>
  <verify>
- `npx tsc --noEmit` passes
- `npm run build` succeeds
- Step 1: form submits, session created, advances to Step 2
- Step 2: all 4 sub-steps appear in sequence, WeightInput captures weights, calculated values display inline
- Step 3: all 3 sub-steps appear in sequence, WeightInput captures weights, final calculations display inline
- After Step 3 complete, Step 4 unlocks (not locked in step list)
  </verify>
  <done>
- Steps 1-3 are fully functional with real API calls and weight capture
- STK-01 through STK-04 requirements satisfied in Step 2
- DIL-02 through DIL-04 requirements satisfied in Step 3
- SMP-04 requirement satisfied in Step 1
- Calculated values display inline after each weighing section completes
- Re-weigh buttons allow repeating any measurement
- Step state machine correctly advances: completing Step 3 unlocks Step 4
- Step3Dilution follows identical sub-step locking pattern as Step2StockPrep
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` — zero type errors
- `npm run build` — Vite build succeeds
- Full flow test: New Analysis > select peptide > enter target conc/vol > create session > Step 2 weighing sub-steps > Step 3 weighing sub-steps
- Each WeightInput captures weight and records measurement via API
- Calculated values (stock_conc, required volumes, actual_conc) appear inline after relevant weights are accepted
- Navigating back to completed steps shows read-only data with Re-weigh option
- Step 4 unlocks after Step 3 completion
</verification>

<success_criteria>
- Tech can create a wizard session with peptide selection and target params
- Tech can capture all 5 weights across Steps 2-3 using WeightInput (scale or manual)
- Calculated values display inline after each stage completes
- All API calls use correct endpoints and update wizard store
- Re-weigh capability works (inserts new measurement, preserves audit trail)
</success_criteria>

<output>
After completion, create `.planning/phases/04-wizard-ui/04-02-SUMMARY.md`
</output>
