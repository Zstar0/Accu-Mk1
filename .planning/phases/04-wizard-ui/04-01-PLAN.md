---
phase: 04-wizard-ui
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/store/wizard-store.ts
  - src/lib/api.ts
  - src/components/hplc/CreateAnalysis.tsx
  - src/components/hplc/wizard/WizardStepList.tsx
  - src/components/hplc/wizard/WizardStepPanel.tsx
autonomous: true

must_haves:
  truths:
    - "Wizard displays a vertical step list (left sidebar) alongside the step content panel (right)"
    - "Steps show 4 states: not-started, in-progress, complete, locked"
    - "Tech cannot advance to a locked step"
    - "Tech can navigate back to review completed steps"
    - "Transitions between steps are animated"
  artifacts:
    - path: "src/store/wizard-store.ts"
      provides: "PrepWizardStore with session state, step navigation, derived step states"
      exports: ["useWizardStore"]
    - path: "src/lib/api.ts"
      provides: "Wizard API functions"
      exports: ["createWizardSession", "getWizardSession", "recordWizardMeasurement", "updateWizardSession", "completeWizardSession", "listWizardSessions"]
    - path: "src/components/hplc/CreateAnalysis.tsx"
      provides: "WizardPage layout with split-panel design"
    - path: "src/components/hplc/wizard/WizardStepList.tsx"
      provides: "Vertical step sidebar with 4-state indicators"
    - path: "src/components/hplc/wizard/WizardStepPanel.tsx"
      provides: "Animated content area wrapper with directional slide transitions"
  key_links:
    - from: "src/components/hplc/CreateAnalysis.tsx"
      to: "src/store/wizard-store.ts"
      via: "useWizardStore selectors"
      pattern: "useWizardStore\\(state =>"
    - from: "src/store/wizard-store.ts"
      to: "src/lib/api.ts"
      via: "API calls in store actions"
      pattern: "(createWizardSession|getWizardSession|recordWizardMeasurement)"
    - from: "src/components/hplc/wizard/WizardStepList.tsx"
      to: "src/store/wizard-store.ts"
      via: "step states and navigation"
      pattern: "useWizardStore\\(state =>"
---

<objective>
Create the PrepWizardStore (Zustand), wizard API functions, and the WizardPage layout with Stripe-style split-panel design, vertical step sidebar, animated transitions, and step state machine.

Purpose: This is the foundation that all 5 wizard step components will mount into. Without the store, API layer, and layout shell, no step can function.
Output: A navigable wizard skeleton where steps show correct lock/unlock states and transitions animate, with placeholder content for each step slot.
</objective>

<execution_context>
@C:\Users\forre\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\forre\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-wizard-ui/04-RESEARCH.md
@src/store/ui-store.ts
@src/lib/api.ts
@src/components/hplc/CreateAnalysis.tsx
@src/components/hplc/HPLCAnalysis.tsx
@src/components/hplc/WeightInput.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wizard API functions and PrepWizardStore</name>
  <files>src/lib/api.ts, src/store/wizard-store.ts</files>
  <action>
**1. Add wizard API functions to `src/lib/api.ts`** (append at end, use existing `getBearerHeaders` pattern):

Add TypeScript interfaces matching the backend Pydantic schemas:
- `WizardMeasurementResponse` — `{ id: number, session_id: number, step_key: string, weight_mg: number, source: string, is_current: boolean, recorded_at: string }`
- `WizardSessionResponse` — `{ id: number, peptide_id: number, calibration_curve_id: number | null, status: string, sample_id_label: string | null, declared_weight_mg: number | null, target_conc_ug_ml: number | null, target_total_vol_ul: number | null, peak_area: number | null, created_at: string, updated_at: string, completed_at: string | null, measurements: WizardMeasurementResponse[], calculations: Record<string, number> | null }`
- `WizardSessionListItem` — `{ id: number, peptide_id: number, status: string, sample_id_label: string | null, declared_weight_mg: number | null, created_at: string, updated_at: string, completed_at: string | null }`

Add 6 API functions:
- `createWizardSession(data: { peptide_id: number, sample_id_label?: string, declared_weight_mg?: number, target_conc_ug_ml?: number, target_total_vol_ul?: number }): Promise<WizardSessionResponse>` — POST /wizard/sessions
- `getWizardSession(sessionId: number): Promise<WizardSessionResponse>` — GET /wizard/sessions/{id}
- `listWizardSessions(params?: { status?: string, peptide_id?: number, limit?: number, offset?: number }): Promise<WizardSessionListItem[]>` — GET /wizard/sessions
- `recordWizardMeasurement(sessionId: number, data: { step_key: string, weight_mg: number, source: string }): Promise<WizardSessionResponse>` — POST /wizard/sessions/{id}/measurements
- `updateWizardSession(sessionId: number, data: { sample_id_label?: string, declared_weight_mg?: number, target_conc_ug_ml?: number, target_total_vol_ul?: number, peak_area?: number }): Promise<WizardSessionResponse>` — PATCH /wizard/sessions/{id}
- `completeWizardSession(sessionId: number): Promise<WizardSessionResponse>` — POST /wizard/sessions/{id}/complete

Follow exact pattern of existing API functions (try/catch, getBearerHeaders, API_BASE_URL(), throw on !response.ok).

**2. Create `src/store/wizard-store.ts`** — PrepWizardStore using Zustand v5 with devtools middleware:

Types:
```typescript
type StepId = 1 | 2 | 3 | 4 | 5
type StepState = 'not-started' | 'in-progress' | 'complete' | 'locked'

interface WizardStoreState {
  // Session data
  session: WizardSessionResponse | null
  currentStep: StepId
  loading: boolean
  error: string | null

  // Actions
  startSession: (session: WizardSessionResponse) => void
  updateSession: (session: WizardSessionResponse) => void
  setCurrentStep: (step: StepId) => void
  setLoading: (loading: boolean) => void
  setError: (error: string | null) => void
  resetWizard: () => void

  // Derived (computed via pure function, not stored)
  getStepStates: () => Record<StepId, StepState>
  canAdvance: () => boolean
}
```

Step state derivation — implement as a pure function `deriveStepStates(session: WizardSessionResponse | null, currentStep: StepId): Record<StepId, StepState>`:
- Step 1: `in-progress` if currentStep === 1 and session is null; `complete` if session exists (was created); `not-started` if none
- Step 2: `locked` if session is null or `target_conc_ug_ml` is null or `target_total_vol_ul` is null; `in-progress` if currentStep === 2; `complete` if `calculations?.stock_conc_ug_ml` is not null
- Step 3: `locked` if `calculations?.stock_conc_ug_ml` is null; `in-progress` if currentStep === 3; `complete` if `calculations?.actual_conc_ug_ml` is not null
- Step 4: `locked` if `calculations?.actual_conc_ug_ml` is null; `in-progress` if currentStep === 4; `complete` if `calculations?.determined_conc_ug_ml` is not null
- Step 5: `locked` if `calculations?.determined_conc_ug_ml` is null; `in-progress` if currentStep === 5; `complete` if session.status === 'completed'

For current step: always `in-progress` (override locked/not-started).
For steps before currentStep with data: `complete`.
For steps after currentStep without unlock condition: `locked`.

Navigation logic:
- `setCurrentStep`: only allow if target step state is not `locked`
- `canAdvance`: returns true if step `currentStep + 1` is not `locked`

CRITICAL: Use Zustand v5 selector syntax ONLY. Export `useWizardStore` with `create<WizardStoreState>()(devtools(...))` pattern matching `ui-store.ts`. NO destructuring patterns — ast-grep enforced.

Step labels constant (exported): `WIZARD_STEPS: { id: StepId, label: string }[]` = [{ id: 1, label: 'Sample Info' }, { id: 2, label: 'Stock Prep' }, { id: 3, label: 'Dilution' }, { id: 4, label: 'Results' }, { id: 5, label: 'Summary' }]
  </action>
  <verify>
- `npx tsc --noEmit` passes (no type errors in wizard-store.ts or api.ts)
- `import { useWizardStore, WIZARD_STEPS, deriveStepStates } from '@/store/wizard-store'` resolves
- `import { createWizardSession, getWizardSession, recordWizardMeasurement, updateWizardSession, completeWizardSession, listWizardSessions } from '@/lib/api'` resolves
  </verify>
  <done>
- wizard-store.ts exports useWizardStore with session state, step navigation, and deriveStepStates
- api.ts has 6 wizard API functions and 3 TypeScript interfaces matching backend schemas
- All types compile without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: WizardPage layout, WizardStepList, and WizardStepPanel</name>
  <files>src/components/hplc/CreateAnalysis.tsx, src/components/hplc/wizard/WizardStepList.tsx, src/components/hplc/wizard/WizardStepPanel.tsx</files>
  <action>
**1. Create `src/components/hplc/wizard/WizardStepList.tsx`** — Vertical step sidebar:

Renders WIZARD_STEPS as a vertical list. For each step:
- Read step states from `useWizardStore(state => state.getStepStates())`
- Visual indicators per state:
  - `not-started`: gray circle with step number, muted text
  - `in-progress`: blue/primary filled circle with step number, bold text
  - `complete`: green circle with check icon (lucide `Check`), normal text
  - `locked`: gray circle with lock icon (lucide `Lock`), muted text, cursor-not-allowed
- Click handler: calls `useWizardStore.getState().setCurrentStep(step.id)` — store rejects if locked
- Active step highlighted with left border accent or background tint
- Use Tailwind classes only. No custom CSS. Match existing app aesthetic (see AnalysisHistory.tsx for style reference).

**2. Create `src/components/hplc/wizard/WizardStepPanel.tsx`** — Animated content wrapper:

Props: `{ children: React.ReactNode, stepId: number }`

Animation approach:
- Track previous step ID via `useRef` to determine direction (forward = slide from right, back = slide from left)
- Use `key={stepId}` on the animated wrapper div to force remount and restart animation
- CSS classes from tw-animate-css (already imported globally):
  - Forward: `animate-in slide-in-from-right-4 fade-in duration-200`
  - Back: `animate-in slide-in-from-left-4 fade-in duration-200`
- Store direction in a ref that updates when stepId changes

**3. Rewrite `src/components/hplc/CreateAnalysis.tsx`** — Full WizardPage:

Replace the "Coming Soon" placeholder with the wizard layout:

Layout structure (flex row, full height):
```
<div className="flex h-full">
  {/* Left sidebar — step list */}
  <div className="w-64 shrink-0 border-r p-4">
    <WizardStepList />
  </div>
  {/* Right content — step panel */}
  <div className="flex-1 overflow-y-auto p-6">
    <WizardStepPanel stepId={currentStep}>
      {renderCurrentStep()}
    </WizardStepPanel>
  </div>
</div>
```

`renderCurrentStep()` — switch on `currentStep`:
- 1: `<div>Step 1: Sample Info (placeholder)</div>`
- 2: `<div>Step 2: Stock Prep (placeholder)</div>`
- 3: `<div>Step 3: Dilution (placeholder)</div>`
- 4: `<div>Step 4: Results (placeholder)</div>`
- 5: `<div>Step 5: Summary (placeholder)</div>`

These placeholders will be replaced by real step components in Plans 04-02 and 04-03.

Read `currentStep` from store: `const currentStep = useWizardStore(state => state.currentStep)`

Add "Back" and "Next" navigation buttons below the step content:
- Back: `<Button variant="outline" onClick={() => setCurrentStep(currentStep - 1)} disabled={currentStep === 1}>Back</Button>`
- Next: `<Button onClick={() => setCurrentStep(currentStep + 1)} disabled={!canAdvance()}>Next Step</Button>`
- Use `useWizardStore.getState()` for action calls in click handlers per architecture rules.

CRITICAL: Do NOT import from ui-store.ts. Do NOT add new subsections to ui-store. The wizard state lives entirely in wizard-store.ts.
  </action>
  <verify>
- `npx tsc --noEmit` passes
- `npm run build` succeeds (Vite build, no runtime errors in compiled output)
- Navigating to "New Analysis" in the sidebar renders the wizard layout with step sidebar showing 5 steps (Step 1 in-progress, Steps 2-5 locked), and placeholder content for Step 1 in the right panel
  </verify>
  <done>
- CreateAnalysis.tsx shows Stripe-style split-panel wizard layout (step sidebar left, content right)
- WizardStepList renders 5 steps with correct 4-state visual indicators
- WizardStepPanel wraps content with directional slide animations on step change
- Back/Next buttons navigate between steps respecting lock states
- No changes to ui-store.ts or AppSidebar.tsx
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` — zero type errors
- `npm run build` — Vite build succeeds
- Navigate to HPLC Analysis > New Analysis in the app: wizard layout visible with 5-step sidebar
- Step 1 shows as in-progress (blue), Steps 2-5 show as locked (gray + lock icon)
- Clicking a locked step does nothing; clicking Step 1 (already active) stays on Step 1
- Back button is disabled on Step 1; Next button is disabled (Step 2 is locked since no session created yet)
</verification>

<success_criteria>
- Wizard store manages session state with correct step lock/unlock derivation
- API layer has all 6 wizard endpoint functions with correct TypeScript types
- Wizard UI renders split-panel layout with animated transitions
- Step navigation respects sequential locking — cannot skip ahead
- All code follows Zustand v5 selector patterns (no destructuring)
</success_criteria>

<output>
After completion, create `.planning/phases/04-wizard-ui/04-01-SUMMARY.md`
</output>
