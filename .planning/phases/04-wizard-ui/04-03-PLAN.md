---
phase: 04-wizard-ui
plan: 03
type: execute
wave: 3
depends_on: ["04-01", "04-02"]
files_modified:
  - src/components/hplc/CreateAnalysis.tsx
  - src/components/hplc/wizard/steps/Step4Results.tsx
  - src/components/hplc/wizard/steps/Step5Summary.tsx
  - src/components/hplc/wizard/WizardSessionHistory.tsx
  - src/components/hplc/AnalysisHistory.tsx
autonomous: true

must_haves:
  truths:
    - "Tech can enter peak area after HPLC run and see determined concentration, dilution factor, peptide mass, purity"
    - "Summary step shows all measurements and calculated results in read-only view"
    - "Completing a session resets wizard and session appears in Analysis History"
    - "Analysis History has tabs for HPLC Import and Sample Prep Wizard sessions"
  artifacts:
    - path: "src/components/hplc/wizard/steps/Step4Results.tsx"
      provides: "Peak area input with results display (RES-01)"
    - path: "src/components/hplc/wizard/steps/Step5Summary.tsx"
      provides: "Read-only summary of all measurements and results with Complete button (RES-03)"
    - path: "src/components/hplc/wizard/WizardSessionHistory.tsx"
      provides: "Completed wizard sessions list (SESS-04)"
    - path: "src/components/hplc/AnalysisHistory.tsx"
      provides: "Tabbed view with HPLC Import and Sample Prep Wizard tabs"
  key_links:
    - from: "src/components/hplc/wizard/steps/Step4Results.tsx"
      to: "src/lib/api.ts"
      via: "updateWizardSession with peak_area"
      pattern: "updateWizardSession"
    - from: "src/components/hplc/wizard/steps/Step5Summary.tsx"
      to: "src/lib/api.ts"
      via: "completeWizardSession on Complete button"
      pattern: "completeWizardSession"
    - from: "src/components/hplc/wizard/WizardSessionHistory.tsx"
      to: "src/lib/api.ts"
      via: "listWizardSessions with status=completed"
      pattern: "listWizardSessions"
    - from: "src/components/hplc/AnalysisHistory.tsx"
      to: "src/components/hplc/wizard/WizardSessionHistory.tsx"
      via: "Tab content rendering"
      pattern: "WizardSessionHistory"
---

<objective>
Implement wizard Steps 4-5 (Results entry and Summary), the WizardSessionHistory list, and add tabbed navigation to AnalysisHistory. After this plan, the complete wizard flow is functional end-to-end and completed sessions are visible in Analysis History.

Purpose: Complete the wizard UI — tech can enter HPLC results, view a full summary, complete the session, and find it in history.
Output: Steps 4-5 functional, Analysis History shows completed wizard sessions in a new tab.
</objective>

<execution_context>
@C:\Users\forre\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\forre\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-wizard-ui/04-RESEARCH.md
@.planning/phases/04-wizard-ui/04-01-SUMMARY.md
@.planning/phases/04-wizard-ui/04-02-SUMMARY.md
@src/store/wizard-store.ts
@src/lib/api.ts
@src/components/hplc/AnalysisHistory.tsx
@src/components/hplc/CreateAnalysis.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Step4Results and Step5Summary</name>
  <files>src/components/hplc/wizard/steps/Step4Results.tsx, src/components/hplc/wizard/steps/Step5Summary.tsx, src/components/hplc/CreateAnalysis.tsx</files>
  <action>
**1. Create `src/components/hplc/wizard/steps/Step4Results.tsx`** — Results entry (RES-01):

Read session from `useWizardStore(state => state.session)`.

**Layout:**
- Header: "Results Entry" with description "Enter the peak area from the HPLC run"
- Number input for peak area: `<Input type="number" step="0.01" placeholder="e.g. 150000" />`
- "Save Results" button: calls `updateWizardSession(session.id, { peak_area: parseFloat(value) })` then `useWizardStore.getState().updateSession(response)`
- Show loading state on button while saving

**After peak_area saved** (session.peak_area is not null AND session.calculations has results):
- Display calculated results in a summary card:
  - `determined_conc_ug_ml` — "Determined Concentration: {X} ug/mL"
  - `dilution_factor` — "Dilution Factor: {X}"
  - `peptide_mass_mg` — "Peptide Mass: {X} mg"
  - `purity_pct` — "Purity: {X}%"
- Format: determined_conc to 2 decimal places, dilution_factor to 2, peptide_mass to 4, purity to 2
- Show as a Card with green accent border

**If peak_area already saved** (user revisiting Step 4):
- Show the saved peak_area in the input (pre-filled)
- Show the calculated results
- Allow updating: change value and click "Update Results"

**Edge case:** If calculations are null even after peak_area is saved (missing calibration data), show warning: "Results could not be calculated. Check calibration curve."

**2. Create `src/components/hplc/wizard/steps/Step5Summary.tsx`** — Full summary (RES-03):

Read session from `useWizardStore(state => state.session)`.

**Layout — Read-only summary of the entire session:**

Sections (each in a Card or bordered div):

**Section A: Sample Information**
- Peptide ID: session.peptide_id (ideally show name — can fetch from getPeptides or just show ID)
- Sample ID: session.sample_id_label || "Not provided"
- Declared Weight: session.declared_weight_mg ? `${X} mg` : "Not provided"
- Target Concentration: `${session.target_conc_ug_ml} ug/mL`
- Target Total Volume: `${session.target_total_vol_ul} uL`

**Section B: Stock Preparation Measurements**
- For each measurement in session.measurements where step_key starts with "stock_":
  - Display step_key label (map: stock_vial_empty_mg -> "Empty Vial + Cap", stock_vial_loaded_mg -> "Vial + Cap + Diluent") + value in mg + source badge (scale/manual)
- Stock Concentration: `${session.calculations?.stock_conc_ug_ml?.toFixed(2)} ug/mL`

**Section C: Dilution Measurements**
- For each measurement in session.measurements where step_key starts with "dil_":
  - Display step_key label + value + source badge
- Actual Concentration: `${session.calculations?.actual_conc_ug_ml?.toFixed(2)} ug/mL`
- Actual Diluent Volume: `${session.calculations?.actual_diluent_vol_ul?.toFixed(1)} uL`
- Actual Stock Volume: `${session.calculations?.actual_stock_vol_ul?.toFixed(1)} uL`

**Section D: HPLC Results**
- Peak Area: `${session.peak_area}`
- Determined Concentration: `${session.calculations?.determined_conc_ug_ml?.toFixed(2)} ug/mL`
- Dilution Factor: `${session.calculations?.dilution_factor?.toFixed(2)}`
- Peptide Mass: `${session.calculations?.peptide_mass_mg?.toFixed(4)} mg`
- Purity: `${session.calculations?.purity_pct?.toFixed(2)}%`

**Complete Session button:**
- `<Button onClick={handleComplete}>Complete Session</Button>`
- `handleComplete`: call `completeWizardSession(session.id)`, then `useWizardStore.getState().resetWizard()`, then navigate to analysis history via `useUIStore.getState().navigateTo('hplc-analysis', 'analysis-history')`
- Show loading state while completing
- After completion, wizard resets (fresh state for next session)

**Step key label mapping** (define as a const object):
```typescript
const STEP_KEY_LABELS: Record<string, string> = {
  stock_vial_empty_mg: 'Empty Vial + Cap',
  stock_vial_loaded_mg: 'Vial + Cap + Diluent',
  dil_vial_empty_mg: 'Empty Dilution Vial + Cap',
  dil_vial_with_diluent_mg: 'Dilution Vial + Diluent',
  dil_vial_final_mg: 'Final Dilution Vial',
}
```

**3. Update `src/components/hplc/CreateAnalysis.tsx`** — Replace Step 4-5 placeholders:

In the `renderCurrentStep()` switch, replace placeholder divs:
- case 4: `<Step4Results />`
- case 5: `<Step5Summary />`

Import the two components from `@/components/hplc/wizard/steps/`.

NOTE: By this point, Plan 04-02 has already replaced cases 1-3 with real components. Only touch cases 4 and 5 in the switch statement. Do NOT modify cases 1-3.

CRITICAL: Use `useWizardStore(state => state.session)` selector syntax. Use `useWizardStore.getState()` for action calls in handlers. For the navigation after completion, import `useUIStore` and use `useUIStore.getState().navigateTo(...)` in the completion handler (getState is fine for callbacks per architecture rules).
  </action>
  <verify>
- `npx tsc --noEmit` passes
- `npm run build` succeeds
- Step 4: enter peak area, save, calculated results appear (determined_conc, purity, etc.)
- Step 5: full read-only summary of all session data, measurements, and calculations
- "Complete Session" button marks session as completed and resets wizard to Step 1
  </verify>
  <done>
- Tech can enter peak area in Step 4 and see all calculated results (RES-01)
- Step 5 shows complete summary of all measurements and results (RES-03)
- Completing session navigates to Analysis History
- Wizard state resets for next session after completion
  </done>
</task>

<task type="auto">
  <name>Task 2: WizardSessionHistory and AnalysisHistory tabs</name>
  <files>src/components/hplc/wizard/WizardSessionHistory.tsx, src/components/hplc/AnalysisHistory.tsx</files>
  <action>
**1. Create `src/components/hplc/wizard/WizardSessionHistory.tsx`** — Completed sessions list (SESS-04):

Fetches completed wizard sessions from `listWizardSessions({ status: 'completed', limit: 50 })`. Note: `listWizardSessions` returns `Promise<WizardSessionListItem[]>` (flat array), so iterate the result directly — no `.items` or `.data` wrapper.

**Layout:**
- Loading state: Loader2 spinner (matches AnalysisHistory pattern)
- Empty state: "No completed wizard sessions yet."
- List view: table matching AnalysisHistory's style:
  - Columns: Sample ID | Status | Declared Weight (mg) | Created | Completed
  - Each row shows: session.sample_id_label || "—", Badge for status, declared_weight_mg?.toFixed(2) || "—", created_at date, completed_at date
  - Rows are not clickable (no detail view for wizard sessions in this phase)

Use local component state for items + loading + error (matches AnalysisHistory pattern — not TanStack Query).

Fetch on mount with useEffect. Show error state if fetch fails.

**2. Update `src/components/hplc/AnalysisHistory.tsx`** — Add tabbed navigation:

CRITICAL: The existing AnalysisHistory.tsx has an early-return pattern where `if (selectedId != null) return <DetailView />` exits BEFORE the list view render. This early return MUST be converted to a conditional render INSIDE the hplc-import TabsContent. If the early return stays as-is, it will bypass the Tabs wrapper when a detail is open, making the tabs disappear.

**Wrong approach (early return bypasses Tabs):**
```tsx
// DO NOT DO THIS — tabs disappear when detail is open
if (selectedId != null) return <DetailView />
return <Tabs>...</Tabs>
```

**Correct approach (conditional inside tab content):**
```tsx
return (
  <div className="flex flex-col gap-4 p-6">
    <Tabs defaultValue="hplc-import">
      <TabsList>
        <TabsTrigger value="hplc-import">HPLC Import</TabsTrigger>
        <TabsTrigger value="wizard-sessions">Sample Prep Wizard</TabsTrigger>
      </TabsList>
      <TabsContent value="hplc-import">
        {selectedId != null ? (
          /* Existing detail view JSX (the content that was in the early return) */
        ) : (
          /* Existing list view JSX (search, table, pagination) */
        )}
      </TabsContent>
      <TabsContent value="wizard-sessions">
        <WizardSessionHistory />
      </TabsContent>
    </Tabs>
  </div>
)
```

Import Tabs components: `import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs'`
Import WizardSessionHistory: `import { WizardSessionHistory } from './wizard/WizardSessionHistory'`

Move ALL existing rendering logic (both the early-return detail view AND the list view) into the hplc-import TabsContent as a ternary. The outer wrapper becomes the Tabs container.

Keep the detail view (selectedId != null branch) inside the hplc-import tab — it only applies to HPLC analyses.

Preserve all existing functionality: search, pagination, delete, detail view — just restructure the render to use conditional instead of early return, and wrap in Tabs.

CRITICAL: Do NOT change the existing AnalysisHistory logic — only restructure the render pattern and add the Tabs wrapper with the new tab.
  </action>
  <verify>
- `npx tsc --noEmit` passes
- `npm run build` succeeds
- Analysis History page shows two tabs: "HPLC Import" and "Sample Prep Wizard"
- "HPLC Import" tab shows existing analysis history (unchanged functionality)
- Clicking into an analysis detail view still shows tabs at the top (not bypassed by early return)
- "Sample Prep Wizard" tab shows completed wizard sessions
- After completing a wizard session, it appears in the "Sample Prep Wizard" tab
  </verify>
  <done>
- WizardSessionHistory lists completed sessions with correct columns (SESS-04)
- AnalysisHistory has tabbed navigation between HPLC Import and Sample Prep Wizard
- Existing HPLC Import functionality is preserved exactly (search, pagination, detail, delete)
- Early return converted to conditional render inside TabsContent — tabs remain visible in detail view
- Completing a wizard session and navigating to history shows it in the wizard tab
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` — zero type errors
- `npm run build` — Vite build succeeds
- Full end-to-end flow: Step 1 create session > Step 2 stock prep > Step 3 dilution > Step 4 enter peak area > Step 5 review summary > Complete > appears in Analysis History "Sample Prep Wizard" tab
- Analysis History "HPLC Import" tab still works exactly as before (no regression)
- Analysis History tabs remain visible even when viewing a detail (early return refactored)
- Step 5 summary shows all measurements, sources (scale/manual), and all calculated values
</verification>

<success_criteria>
- Steps 4 and 5 are fully functional
- Peak area entry triggers full results calculation display (RES-01)
- Summary shows all prep measurements alongside HPLC results (RES-03)
- Completed sessions appear in Analysis History (SESS-04)
- Complete wizard flow works end-to-end from Step 1 through completion
- Existing AnalysisHistory functionality preserved (no regression)
- Early return pattern in AnalysisHistory converted to conditional render inside Tabs
</success_criteria>

<output>
After completion, create `.planning/phases/04-wizard-ui/04-03-SUMMARY.md`
</output>
